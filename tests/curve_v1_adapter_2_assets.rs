//! This module tests the library's analysis capabilities on the
//! `CurveV1Adapter2Assets` contract`.
#![cfg(test)]

use storage_layout_extractor as sle;
use storage_layout_extractor::{
    extractor::{
        chain::{
            version::{ChainVersion, EthereumVersion},
            Chain,
        },
        contract::Contract,
    },
    tc::{self, abi::AbiType},
    vm,
    watchdog::LazyWatchdog,
};

use crate::common::get_bytecode_from_string;

mod common;

/// Tests the library on the bytecode of the CurveV1Adapter2Assets contract
/// deployed [here](https://etherscan.io/address/0xaa6b42aab40c3cfe6c84b563ba37b462e6a447ec#code).
const BYTECODE_STRING: &str =  "608060405234801561001057600080fd5b50600436106103af5760003560e01c806376a2f0f0116101f4578063cc2b27d71161011a578063e3103273116100ad578063f446c1d01161007c578063f446c1d0146108ba578063f851a440146108c2578063fc0c546a146108ca578063fee3f7f9146108f157600080fd5b8063e31032731461085a578063ec026ca71461086d578063ed8e84f314610880578063ef14101e1461089357600080fd5b8063d96c7fce116100e9578063d96c7fce14610824578063dd62ed3e1461082c578063ddca3f431461083f578063e2e7d2641461084757600080fd5b8063cc2b27d7146107c8578063ce30bbdb146107db578063cf023dd0146107ea578063d21220a7146107fd57600080fd5b8063b4b577ad11610192578063bd90df7011610161578063bd90df7014610740578063c12c21c014610767578063c21ee1621461078e578063c6610657146107b557600080fd5b8063b4b577ad1461070a578063b739953e14610712578063b9947eb014610725578063bb7b8b801461073857600080fd5b806382c63066116101ce57806382c63066146106a15780638ba51dfc146106c857806395d89b41146106ef578063a6417ed6146106f757600080fd5b806376a2f0f01461066b57806378aa73a41461067357806379bea6641461068e57600080fd5b80632c5788d2116102d95780635409491a1161027757806363543f061161024657806363543f061461060257806364a89bca1461060a5780636e1d82711461063157806370a082311461065857600080fd5b80635409491a146105ad57806357d78875146105b55780635b36389c146105dc5780635e0d443f146105ef57600080fd5b806333d2ebf2116102b357806333d2ebf21461056c5780633df021241461057f5780634469e30e146105925780634903b0d11461059a57600080fd5b80632c5788d21461052a5780632f7a18811461053d578063313ce5671461056457600080fd5b806314052288116103515780631af4de83116103205780631af4de83146104d55780632081066c146104e857806323746eb8146104f057806325be124e1461050357600080fd5b806314052288146104aa57806314f05979146104b257806318160ddd146104ba5780631a4d01d2146104c257600080fd5b806307211ef71161038d57806307211ef71461043b5780630b4c7e4d1461044e5780630dfe1681146104635780630f6ba8e31461048a57600080fd5b8063065a80d8146103b457806306871163146103da57806306fdde0314610426575b600080fd5b6103c76103c2366004614819565b6108f9565b6040519081526020015b60405180910390f35b6104017f000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4881565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020016103d1565b61042e61091c565b6040516103d191906148aa565b6103c76104493660046148bd565b6109d4565b61046161045c36600461490a565b610aa3565b005b6104017f0000000000000000000000005f98805a4e8be255a32880fdec7f6728c6568ba081565b61049d610498366004614935565b610b40565b6040516103d19190614996565b6103c7610bfe565b61049d610c8f565b6103c7610d25565b6104616104d03660046149a4565b610d92565b6104616104e33660046148bd565b610e25565b6103c7611133565b6104016104fe366004614819565b6111a0565b6104017f000000000000000000000000000000000000000000000000000000000000000081565b6103c76105383660046149c9565b6111ab565b6104017f000000000000000000000000c59135f449bb623501145443c70a30ee648fa30481565b6103c761185e565b61046161057a3660046149f5565b6118cb565b61046161058d366004614a1f565b61195f565b61049d611a30565b6103c76105a8366004614a61565b611aa2565b6103c7611c3c565b6104017f000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec781565b6104616105ea366004614a7a565b611ca9565b6103c76105fd3660046148bd565b611d23565b6103c7611dab565b6104017f000000000000000000000000bebc44782c7db0a1a60cb6fe97d0b483032ff1c781565b6104017f0000000000000000000000006b175474e89094c44da98b954eedeac495271d0f81565b6103c7610666366004614ac0565b611e18565b6103c7611e91565b61067b600281565b60405161ffff90911681526020016103d1565b61046161069c3660046148bd565b611efe565b6104017f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca81565b6104017f0000000000000000000000005f98805a4e8be255a32880fdec7f6728c6568ba081565b61042e61217a565b610461610705366004614a1f565b6121e7565b6103c7612271565b610401610720366004614819565b6122de565b610401610733366004614a61565b6122e9565b6103c76122ff565b6104017f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca81565b6104017f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b81565b6103c77f000000000000000000000000000000000000000000000000000000000000000281565b6104016107c3366004614a61565b61236c565b6103c76107d63660046149c9565b612382565b60056040516103d19190614add565b6104616107f83660046149a4565b61243f565b6104017f0000000000000000000000006c3f90f043a72fa612cbac8115ee7e52bde6e49081565b61049d6125b9565b6103c761083a366004614b1e565b61262b565b6103c76126ac565b6103c7610855366004614a61565b612719565b61046161086836600461490a565b61278f565b61046161087b3660046149f5565b61281e565b6103c761088e366004614b65565b612a7f565b6104017f000000000000000000000000000000000000000000000000000000000000000081565b6103c7612af6565b610401612b63565b6104017f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca81565b6103c7612bf4565b6000610916826fffffffffffffffffffffffffffffffff16611aa2565b92915050565b60607f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff166306fdde036040518163ffffffff1660e01b8152600401600060405180830381865afa158015610989573d6000803e3d6000fd5b505050506040513d6000823e601f3d9081017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe01682016040526109cf9190810190614c53565b905090565b6040517f07211ef7000000000000000000000000000000000000000000000000000000008152600f84810b600483015283900b6024820152604481018290526000907f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff16906307211ef7906064015b602060405180830381865afa158015610a75573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a999190614ca4565b90505b9392505050565b60026000541415610b15576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c0060448201526064015b60405180910390fd5b60026000908155610b3790600184358110916020860135919091119080612de5565b50506001600055565b610b486147e9565b6040517f0f6ba8e300000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca1690630f6ba8e390610bbe90879087908790600401614cbd565b6040805180830381865afa158015610bda573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a999190614ce4565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1663140522886040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109cf9190614ca4565b610c976147e9565b7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff166314f059796040518163ffffffff1660e01b81526004016040805180830381865afa158015610d01573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109cf9190614ce4565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff166318160ddd6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b60026000541415610dff576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b0c565b60026000908155610e0f83612f2b565b9050610e1a81613042565b505060016000555050565b60026000541415610e92576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b0c565b600260009081556040517fe958b7040000000000000000000000000000000000000000000000000000000081523360048201527f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b73ffffffffffffffffffffffffffffffffffffffff169063e958b70490602401602060405180830381865afa158015610f23573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610f479190614d64565b90506000610f548561315f565b90506000610f618561315f565b6040517f70a0823100000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff85811660048301529192506000918416906370a0823190602401602060405180830381865afa158015610fd3573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610ff79190614ca4565b90506001811115611125577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0160006b033b2e3c9fd0803ce800000061103d8784614d81565b6110479190614de5565b604051600f8a810b602483015289900b60448201526064810184905260848101829052909150611122908690869086907fa6417ed6000000000000000000000000000000000000000000000000000000009060a4015b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529190526020810180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167fffffffff0000000000000000000000000000000000000000000000000000000090931692909217909152600180613275565b50505b505060016000555050505050565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff16632081066c6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b600061091682612f2b565b60007f00000000000000000000000000000000000000000000000000000000000000026002141561137c5781600f0b6000146112ae57604080518082018252600081526020810185905290517fed8e84f300000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca169163ed8e84f3916112689190600190600401614e20565b602060405180830381865afa158015611285573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906112a99190614ca4565b611375565b6040805180820182528481526000602082015290517fed8e84f300000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca169163ed8e84f3916113349190600190600401614e20565b602060405180830381865afa158015611351573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906113759190614ca4565b9050610916565b7f0000000000000000000000000000000000000000000000000000000000000002600314156115625781600f0b6000146114d55781600f0b60011461144857604080516060810182526000808252602082015280820185905290517f3883e11900000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca1691633883e119916112689190600190600401614e3d565b604080516060810182526000808252602082018690528183015290517f3883e11900000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca1691633883e119916112689190600190600401614e3d565b604080516060810182528481526000602082018190528183015290517f3883e11900000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca1691633883e119916113349190600190600401614e3d565b7f0000000000000000000000000000000000000000000000000000000000000002600414156117fc5781600f0b6000146117685781600f0b6001146116d45781600f0b6002146116405760408051608081018252600080825260208201819052818301526060810185905290517fcf701ff700000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca169163cf701ff7916112689190600190600401614e77565b60408051608081018252600080825260208201819052818301869052606082015290517fcf701ff700000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca169163cf701ff7916112689190600190600401614e77565b60408051608081018252600080825260208201869052818301819052606082015290517fcf701ff700000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca169163cf701ff7916112689190600190600401614e77565b60408051608081018252848152600060208201819052818301819052606082015290517fcf701ff700000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca169163cf701ff7916113349190600190600401614e77565b6040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601060248201527f496e636f7272656374206e436f696e73000000000000000000000000000000006044820152606401610b0c565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b60026000541415611938576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b0c565b6002600090815561194883612f2b565b9050611955838284613555565b5050600160005550565b600260005414156119cc576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b0c565b600260009081556119dc85612f2b565b905060006119e985612f2b565b905061112582826000368080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201829052506001935091506137ff9050565b611a386147e9565b7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff16634469e30e6040518163ffffffff1660e01b81526004016040805180830381865afa158015610d01573d6000803e3d6000fd5b6040517f4903b0d1000000000000000000000000000000000000000000000000000000008152600481018290526000907f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1690634903b0d190602401602060405180830381865afa925050508015611b6a575060408051601f3d9081017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0168201909252611b6791810190614ca4565b60015b610916577f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1663065a80d8611bbb611bb685612c61565b612d17565b6040517fffffffff0000000000000000000000000000000000000000000000000000000060e084901b168152600f9190910b60048201526024015b602060405180830381865afa158015611c13573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109169190614ca4565b919050565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff16635409491a6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b60026000541415611d16576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b0c565b6002600055610b376138ce565b6040517f5e0d443f000000000000000000000000000000000000000000000000000000008152600f84810b600483015283900b6024820152604481018290526000907f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1690635e0d443f90606401610a58565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff166363543f066040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b6040517f70a0823100000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff82811660048301526000917f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca909116906370a0823190602401611bf6565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff166376a2f0f06040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b60026000541415611f6b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b0c565b600260009081556040517fe958b7040000000000000000000000000000000000000000000000000000000081523360048201527f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b73ffffffffffffffffffffffffffffffffffffffff169063e958b70490602401602060405180830381865afa158015611ffc573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906120209190614d64565b9050600061202d85612f2b565b9050600061203a85612f2b565b6040517f70a0823100000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff85811660048301529192506000918416906370a0823190602401602060405180830381865afa1580156120ac573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906120d09190614ca4565b90506001811115611125577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0160006b033b2e3c9fd0803ce80000006121168784614d81565b6121209190614de5565b604051600f8a810b602483015289900b60448201526064810184905260848101829052909150611122908690869086907f3df02124000000000000000000000000000000000000000000000000000000009060a40161109d565b60607f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff166395d89b416040518163ffffffff1660e01b8152600401600060405180830381865afa158015610989573d6000803e3d6000fd5b60026000541415612254576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b0c565b600260009081556122648561315f565b905060006119e98561315f565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1663b4b577ad6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b60006109168261315f565b60006109166122fa611bb684612c61565b61315f565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1663bb7b8b806040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b600061091661237d611bb684612c61565b612f2b565b6040517fcc2b27d700000000000000000000000000000000000000000000000000000000815260048101839052600f82900b60248201526000907f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff169063cc2b27d7906044015b602060405180830381865afa15801561241b573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a9c9190614ca4565b600260005414156124ac576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b0c565b600260009081556124bc83612f2b565b6040517fe958b70400000000000000000000000000000000000000000000000000000000815233600482015290915060009073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b169063e958b70490602401602060405180830381865afa15801561254c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906125709190614d64565b90506125ac81837f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca6125a3888a89613aee565b60016000613275565b5050600160005550505050565b6125c16147e9565b7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1663d96c7fce6040518163ffffffff1660e01b81526004016040805180830381865afa158015610d01573d6000803e3d6000fd5b6040517fdd62ed3e00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff838116600483015282811660248301526000917f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca9091169063dd62ed3e906044016123fe565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1663ddca3f436040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b6040517fe2e7d264000000000000000000000000000000000000000000000000000000008152600481018290526000907f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff169063e2e7d26490602401611bf6565b600260005414156127fc576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b0c565b60026000908155610b3790600184358110916020860135919091119080613f4b565b6002600054141561288b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b0c565b6002600090815561289b83612f2b565b6040517fe958b70400000000000000000000000000000000000000000000000000000000815233600482015290915060009073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b169063e958b70490602401602060405180830381865afa15801561292b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061294f9190614d64565b6040517f70a0823100000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff80831660048301529192506000918416906370a0823190602401602060405180830381865afa1580156129c1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906129e59190614ca4565b90506001811115612a73577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0160006b033b2e3c9fd0803ce8000000612a2b8684614d81565b612a359190614de5565b9050612a7083857f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca612a688a8787613aee565b600180613275565b50505b50506001600055505050565b6040517fed8e84f300000000000000000000000000000000000000000000000000000000815260009073ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca169063ed8e84f3906123fe9086908690600401614eb1565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1663f446c1d06040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1663f851a4406040518163ffffffff1660e01b8152600401602060405180830381865afa158015612bd0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109cf9190614d64565b60007f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca73ffffffffffffffffffffffffffffffffffffffff1663fee3f7f96040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c6b573d6000803e3d6000fd5b60007f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821115612d13576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602860248201527f53616665436173743a2076616c756520646f65736e27742066697420696e206160448201527f6e20696e743235360000000000000000000000000000000000000000000000006064820152608401610b0c565b5090565b60007fffffffffffffffffffffffffffffffff800000000000000000000000000000008212801590612d5957506f7fffffffffffffffffffffffffffffff8213155b612d13576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602760248201527f53616665436173743a2076616c756520646f65736e27742066697420696e203160448201527f32382062697473000000000000000000000000000000000000000000000000006064820152608401610b0c565b6040517fe958b7040000000000000000000000000000000000000000000000000000000081523360048201526000907f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b73ffffffffffffffffffffffffffffffffffffffff169063e958b70490602401602060405180830381865afa158015612e72573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612e969190614d64565b9050612ea485858585614108565b612ece817f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca61424e565b612f0e6000368080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152506142f492505050565b50612f1b85858585614108565b612f24816143f2565b5050505050565b600081600f0b60001415612f6057507f0000000000000000000000005f98805a4e8be255a32880fdec7f6728c6568ba0612ff5565b81600f0b60011415612f9357507f0000000000000000000000006c3f90f043a72fa612cbac8115ee7e52bde6e490612ff5565b81600f0b60021415612fc657507f0000000000000000000000000000000000000000000000000000000000000000612ff5565b81600f0b60031415612ff557507f00000000000000000000000000000000000000000000000000000000000000005b73ffffffffffffffffffffffffffffffffffffffff8116611c37576040517fd1da79bc00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6040517fe958b7040000000000000000000000000000000000000000000000000000000081523360048201526000907f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b73ffffffffffffffffffffffffffffffffffffffff169063e958b70490602401602060405180830381865afa1580156130cf573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906130f39190614d64565b905061315a817f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca846000368080601f016020809104026020016040519081016040528093929190818152602001838380828437600092018290525092508291506132759050565b505050565b600081600f0b6000141561319457507f0000000000000000000000005f98805a4e8be255a32880fdec7f6728c6568ba0612ff5565b81600f0b600114156131c757507f0000000000000000000000006b175474e89094c44da98b954eedeac495271d0f612ff5565b81600f0b600214156131fa57507f000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48612ff5565b81600f0b60031415612ff557507f000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec773ffffffffffffffffffffffffffffffffffffffff8116611c37576040517fd1da79bc00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60606000803373ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000c59135f449bb623501145443c70a30ee648fa30416146133de576040517f70a0823100000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff8a811660048301528916906370a0823190602401602060405180830381865afa158015613323573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906133479190614ca4565b6040517f70a0823100000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff8b81166004830152919350908816906370a0823190602401602060405180830381865afa1580156133b7573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906133db9190614ca4565b90505b841561340e5761340e887fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6144cc565b6040517f6ce4074a00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b1690636ce4074a906134a49033907f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca908b90600401614ec9565b6000604051808303816000875af11580156134c3573d6000803e3d6000fd5b505050506040513d6000823e601f3d9081017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe01682016040526135099190810190614c53565b9250841561353b5761353b887fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6144cc565b613549898989858589614575565b50509695505050505050565b6040517fe958b7040000000000000000000000000000000000000000000000000000000081523360048201526000907f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b73ffffffffffffffffffffffffffffffffffffffff169063e958b70490602401602060405180830381865afa1580156135e2573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906136069190614d64565b6040517f70a0823100000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff80831660048301529192506000917f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca16906370a0823190602401602060405180830381865afa158015613698573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906136bc9190614ca4565b90506001811115612f24577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff016137f7827f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca867f1a4d01d200000000000000000000000000000000000000000000000000000000858a6b033b2e3c9fd0803ce80000006137498b84614d81565b6137539190614de5565b6040516024810193909352600f9190910b60448301526064820152608401604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529190526020810180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167fffffffff000000000000000000000000000000000000000000000000000000009093169290921790915260006001613275565b505050505050565b6040517fe958b70400000000000000000000000000000000000000000000000000000000815233600482015260609060009073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b169063e958b70490602401602060405180830381865afa15801561388f573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906138b39190614d64565b90506138c3818888888888613275565b979650505050505050565b6040517fe958b7040000000000000000000000000000000000000000000000000000000081523360048201526000907f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b73ffffffffffffffffffffffffffffffffffffffff169063e958b70490602401602060405180830381865afa15801561395b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061397f9190614d64565b90506139ab817f0000000000000000000000005f98805a4e8be255a32880fdec7f6728c6568ba061424e565b6139d5817f0000000000000000000000006c3f90f043a72fa612cbac8115ee7e52bde6e49061424e565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1615613aa157613a3b817f000000000000000000000000000000000000000000000000000000000000000061424e565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1615613aa157613aa1817f000000000000000000000000000000000000000000000000000000000000000061424e565b613ae16000368080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152506142f492505050565b50613aeb816143f2565b50565b60607f000000000000000000000000000000000000000000000000000000000000000260021415613ca75783600f0b600014613be4576040516000602482015260448101849052606481018390527f0b4c7e4d00000000000000000000000000000000000000000000000000000000906084015b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529190526020810180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167fffffffff0000000000000000000000000000000000000000000000000000000090931692909217909152613ca0565b6040516024810184905260006044820152606481018390527f0b4c7e4d00000000000000000000000000000000000000000000000000000000906084015b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529190526020810180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167fffffffff00000000000000000000000000000000000000000000000000000000909316929092179091525b9050610a9c565b7f000000000000000000000000000000000000000000000000000000000000000260031415613dc15783600f0b600014613d785783600f0b600114613d2f57604051600060248201819052604482015260648101849052608481018390527f4515cef3000000000000000000000000000000000000000000000000000000009060a401613b62565b604051600060248201819052604482018590526064820152608481018390527f4515cef3000000000000000000000000000000000000000000000000000000009060a401613b62565b604051602481018490526000604482018190526064820152608481018390527f4515cef3000000000000000000000000000000000000000000000000000000009060a401613c22565b7f0000000000000000000000000000000000000000000000000000000000000002600414156117fc5783600f0b600014613efb5783600f0b600114613eab5783600f0b600214613e5b576040516000602482018190526044820181905260648201526084810184905260a481018390527f029b2f34000000000000000000000000000000000000000000000000000000009060c401613b62565b6040516000602482018190526044820181905260648201859052608482015260a481018390527f029b2f34000000000000000000000000000000000000000000000000000000009060c401613b62565b6040516000602482018190526044820185905260648201819052608482015260a481018390527f029b2f34000000000000000000000000000000000000000000000000000000009060c401613b62565b6040516024810184905260006044820181905260648201819052608482015260a481018390527f029b2f34000000000000000000000000000000000000000000000000000000009060c401613c22565b6040517fe958b7040000000000000000000000000000000000000000000000000000000081523360048201526000907f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b73ffffffffffffffffffffffffffffffffffffffff169063e958b70490602401602060405180830381865afa158015613fd8573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190613ffc9190614d64565b9050841561402e5761402e817f0000000000000000000000005f98805a4e8be255a32880fdec7f6728c6568ba061424e565b831561405e5761405e817f0000000000000000000000006c3f90f043a72fa612cbac8115ee7e52bde6e49061424e565b821561408e5761408e817f000000000000000000000000000000000000000000000000000000000000000061424e565b81156140be576140be817f000000000000000000000000000000000000000000000000000000000000000061424e565b6140fe6000368080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152506142f492505050565b50612f24816143f2565b8315614158576141587f0000000000000000000000005f98805a4e8be255a32880fdec7f6728c6568ba07fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6144cc565b82156141a8576141a87f0000000000000000000000006c3f90f043a72fa612cbac8115ee7e52bde6e4907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6144cc565b81156141f8576141f87f00000000000000000000000000000000000000000000000000000000000000007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6144cc565b8015614248576142487f00000000000000000000000000000000000000000000000000000000000000007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6144cc565b50505050565b6040517f51e3f16000000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff838116600483015282811660248301527f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b16906351e3f160906044015b600060405180830381600087803b1580156142e057600080fd5b505af11580156137f7573d6000803e3d6000fd5b6040517f6ce4074a00000000000000000000000000000000000000000000000000000000815260609073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b1690636ce4074a9061438d9033907f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca908790600401614ec9565b6000604051808303816000875af11580156143ac573d6000803e3d6000fd5b505050506040513d6000823e601f3d9081017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe01682016040526109169190810190614c53565b3373ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000c59135f449bb623501145443c70a30ee648fa3041614613aeb576040517f9537301800000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff82811660048301527f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b1690639537301890602401600060405180830381600087803b1580156144b857600080fd5b505af1158015612f24573d6000803e3d6000fd5b6040517f46fb371d00000000000000000000000000000000000000000000000000000000815233600482015273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ed279fdd11ca84beef15af5d39bb4d4bee23f0ca811660248301528381166044830152606482018390527f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b16906346fb371d906084016142c6565b3373ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000c59135f449bb623501145443c70a30ee648fa3041614614676576040517f654a9eda00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff87811660048301528681166024830152858116604483015260648201859052608482018490527f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b169063654a9eda9060a401600060405180830381600087803b15801561465957600080fd5b505af115801561466d573d6000803e3d6000fd5b505050506137f7565b8015614738576040517f0d8f9cee00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff878116600483015286811660248301527f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b1690630d8f9cee906044016020604051808303816000875af1158015614712573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906147369190614f0b565b505b6040517f51e3f16000000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff878116600483015285811660248301527f0000000000000000000000005887ad4cb2352e7f01527035faa3ae0ef2ce2b9b16906351e3f16090604401600060405180830381600087803b1580156147c957600080fd5b505af11580156147dd573d6000803e3d6000fd5b50505050505050505050565b60405180604001604052806002906020820280368337509192915050565b8035600f81900b8114611c3757600080fd5b60006020828403121561482b57600080fd5b610a9c82614807565b60005b8381101561484f578181015183820152602001614837565b838111156142485750506000910152565b60008151808452614878816020860160208601614834565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169290920160200192915050565b602081526000610a9c6020830184614860565b6000806000606084860312156148d257600080fd5b6148db84614807565b92506148e960208501614807565b9150604084013590509250925092565b806040810183101561091657600080fd5b6000806060838503121561491d57600080fd5b61492784846148f9565b946040939093013593505050565b600080600060a0848603121561494a57600080fd5b61495485856148f9565b925061496385604086016148f9565b9150608084013590509250925092565b8060005b6002811015614248578151845260209384019390910190600101614977565b604081016109168284614973565b6000806000606084860312156149b957600080fd5b833592506148e960208501614807565b600080604083850312156149dc57600080fd5b823591506149ec60208401614807565b90509250929050565b60008060408385031215614a0857600080fd5b614a1183614807565b946020939093013593505050565b60008060008060808587031215614a3557600080fd5b614a3e85614807565b9350614a4c60208601614807565b93969395505050506040820135916060013590565b600060208284031215614a7357600080fd5b5035919050565b60008060608385031215614a8d57600080fd5b823591506149ec84602085016148f9565b73ffffffffffffffffffffffffffffffffffffffff81168114613aeb57600080fd5b600060208284031215614ad257600080fd5b8135610a9c81614a9e565b6020810160108310614b18577f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b91905290565b60008060408385031215614b3157600080fd5b8235614b3c81614a9e565b91506020830135614b4c81614a9e565b809150509250929050565b8015158114613aeb57600080fd5b60008060608385031215614b7857600080fd5b614b8284846148f9565b91506040830135614b4c81614b57565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600067ffffffffffffffff80841115614bdc57614bdc614b92565b604051601f85017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f01168101908282118183101715614c2257614c22614b92565b81604052809350858152868686011115614c3b57600080fd5b614c49866020830187614834565b5050509392505050565b600060208284031215614c6557600080fd5b815167ffffffffffffffff811115614c7c57600080fd5b8201601f81018413614c8d57600080fd5b614c9c84825160208401614bc1565b949350505050565b600060208284031215614cb657600080fd5b5051919050565b60a08101604085833760408201600081526040858237506080919091019190915292915050565b600060408284031215614cf657600080fd5b82601f830112614d0557600080fd5b6040516040810181811067ffffffffffffffff82111715614d2857614d28614b92565b8060405250806040840185811115614d3f57600080fd5b845b81811015614d59578051835260209283019201614d41565b509195945050505050565b600060208284031215614d7657600080fd5b8151610a9c81614a9e565b6000817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615614de0577f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b500290565b600082614e1b577f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b500490565b60608101614e2e8285614973565b82151560408301529392505050565b60808101818460005b6003811015614e65578151835260209283019290910190600101614e46565b50505082151560608301529392505050565b60a08101818460005b6004811015614e9f578151835260209283019290910190600101614e80565b50505082151560808301529392505050565b60608101604084833791151560409190910152919050565b600073ffffffffffffffffffffffffffffffffffffffff808616835280851660208401525060606040830152614f026060830184614860565b95945050505050565b600060208284031215614f1d57600080fd5b8151610a9c81614b5756fea2646970667358221220ef0693e8900e50d6f1975553a9fb7ab796b741730a062c5dbb05af62515f319364736f6c634300080a0033";

#[test]
fn correctly_generates_a_layout_wth_permissive_errors() -> anyhow::Result<()> {
    // Create the extractor
    let bytecode = get_bytecode_from_string(BYTECODE_STRING)?;
    let contract = Contract::new(
        bytecode,
        Chain::Ethereum {
            version: EthereumVersion::latest(),
        },
    );

    let vm_config = vm::Config::default().with_permissive_errors(true);
    let unifier_config = tc::Config::default();
    let watchdog = LazyWatchdog.in_rc();

    let extractor = sle::new(contract, vm_config, unifier_config, watchdog);

    // Get the final storage layout for the input contract
    let layout = extractor.analyze()?;

    // We should see one slot
    assert_eq!(layout.slot_count(), 1);

    // `uint256` but we infer `BytesUnknown`
    assert!(layout.has_slot(0, 0, AbiType::Bytes { length: None }));

    Ok(())
}

#[test]
fn correctly_fail_without_permissive_errors() -> anyhow::Result<()> {
    // Create the extractor
    let bytecode = get_bytecode_from_string(BYTECODE_STRING)?;
    let contract = Contract::new(
        bytecode,
        Chain::Ethereum {
            version: EthereumVersion::latest(),
        },
    );

    let vm_config = vm::Config::default().with_permissive_errors(false);
    let unifier_config = tc::Config::default();
    let watchdog = LazyWatchdog.in_rc();

    let extractor = sle::new(contract, vm_config, unifier_config, watchdog);

    // Get the final storage layout for the input contract
    let layout = extractor.analyze();

    // We expect this to fail if not running with permissive errors on
    assert!(layout.is_err());

    Ok(())
}
