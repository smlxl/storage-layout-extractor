//! This module tests the library's analysis capabilities on the `Kakigori`
//! contract`.
#![cfg(test)]

use storage_layout_extractor::{
    tc::abi::{AbiType, StructElement},
    watchdog::LazyWatchdog,
};

mod common;

/// Tests the library on the bytecode of the Kakigori contract deployed
/// [here](https://etherscan.io/address/0xf31603e71e92cdf4dc52ed89302455cc57c73de6).
#[test]
fn correctly_generates_a_layout() -> anyhow::Result<()> {
    // Create the extractor
    let bytecode = "0x6080604052600436106102675760003560e01c80638da5cb5b11610144578063becf98c4116100b6578063d86a28bb1161007a578063d86a28bb1461090e578063e814db5914610918578063e985e9c514610941578063f4ab9adf1461097e578063f851a440146109a7578063fbafdec2146109d257610267565b8063becf98c41461083d578063c4788efe14610866578063c87b56dd1461087d578063ce8e0c3a146108ba578063d5abeb01146108e357610267565b8063a3ec138d11610108578063a3ec138d1461072f578063a6f9dae11461076e578063b187bd2614610797578063b88d4fde146107c2578063ba05269b146107eb578063bcd57d041461081457610267565b80638da5cb5b146106695780638fff20f31461069457806395d89b41146106bf578063a0712d68146106ea578063a22cb4651461070657610267565b806326541b56116101dd5780636352211e116101a15780636352211e1461054457806370a0823114610581578063773979ab146105be57806378d56e7a146105fb5780637b1773ea1461062457806386c1ff681461064057610267565b806326541b56146104615780632f537dc61461048a57806335b8e820146104b55780633da7d2ed146104f257806342842e0e1461051b57610267565b80630d15fd771161022f5780630d15fd77146103635780630deb56ab1461038e57806312065fe0146103b957806318160ddd146103e45780631e9a69501461040f57806323b872dd1461043857610267565b80630121b93f1461026c57806301ffc9a71461029557806306fdde03146102d2578063081812fc146102fd578063095ea7b31461033a575b600080fd5b34801561027857600080fd5b50610293600480360381019061028e9190613112565b6109fb565b005b3480156102a157600080fd5b506102bc60048036038101906102b79190613197565b610bfd565b6040516102c991906131df565b60405180910390f35b3480156102de57600080fd5b506102e7610cdf565b6040516102f4919061328a565b60405180910390f35b34801561030957600080fd5b50610324600480360381019061031f9190613112565b610d71565b60405161033191906132ed565b60405180910390f35b34801561034657600080fd5b50610361600480360381019061035c9190613334565b610db7565b005b34801561036f57600080fd5b50610378610ece565b6040516103859190613383565b60405180910390f35b34801561039a57600080fd5b506103a3610ed4565b6040516103b09190613383565b60405180910390f35b3480156103c557600080fd5b506103ce610ee1565b6040516103db9190613383565b60405180910390f35b3480156103f057600080fd5b506103f9610ee9565b6040516104069190613383565b60405180910390f35b34801561041b57600080fd5b5061043660048036038101906104319190613334565b610eef565b005b34801561044457600080fd5b5061045f600480360381019061045a919061339e565b610fc4565b005b34801561046d57600080fd5b5061048860048036038101906104839190613526565b611024565b005b34801561049657600080fd5b5061049f61112a565b6040516104ac9190613383565b60405180910390f35b3480156104c157600080fd5b506104dc60048036038101906104d79190613112565b611130565b6040516104e99190613670565b60405180910390f35b3480156104fe57600080fd5b5061051960048036038101906105149190613692565b6112b5565b005b34801561052757600080fd5b50610542600480360381019061053d919061339e565b611353565b005b34801561055057600080fd5b5061056b60048036038101906105669190613112565b611373565b60405161057891906132ed565b60405180910390f35b34801561058d57600080fd5b506105a860048036038101906105a39190613692565b6113f9565b6040516105b59190613383565b60405180910390f35b3480156105ca57600080fd5b506105e560048036038101906105e09190613112565b6114b0565b6040516105f29190613729565b60405180910390f35b34801561060757600080fd5b50610622600480360381019061061d919061374b565b611626565b005b61063e6004803603810190610639919061378b565b6116d3565b005b34801561064c57600080fd5b5061066760048036038101906106629190613692565b61176f565b005b34801561067557600080fd5b5061067e611827565b60405161068b91906132ed565b60405180910390f35b3480156106a057600080fd5b506106a9611851565b6040516106b69190613383565b60405180910390f35b3480156106cb57600080fd5b506106d4611857565b6040516106e1919061328a565b60405180910390f35b61070460048036038101906106ff9190613112565b6118e9565b005b34801561071257600080fd5b5061072d60048036038101906107289190613842565b611a0b565b005b34801561073b57600080fd5b5061075660048036038101906107519190613692565b611a21565b60405161076593929190613882565b60405180910390f35b34801561077a57600080fd5b5061079560048036038101906107909190613692565b611a65565b005b3480156107a357600080fd5b506107ac611b03565b6040516107b991906131df565b60405180910390f35b3480156107ce57600080fd5b506107e960048036038101906107e4919061395a565b611b16565b005b3480156107f757600080fd5b50610812600480360381019061080d9190613692565b611b78565b005b34801561082057600080fd5b5061083b600480360381019061083691906139dd565b611c30565b005b34801561084957600080fd5b50610864600480360381019061085f9190613a68565b611d39565b005b34801561087257600080fd5b5061087b611db0565b005b34801561088957600080fd5b506108a4600480360381019061089f9190613112565b611e14565b6040516108b1919061328a565b60405180910390f35b3480156108c657600080fd5b506108e160048036038101906108dc9190613a95565b611e96565b005b3480156108ef57600080fd5b506108f8611f95565b6040516109059190613383565b60405180910390f35b610916611f9b565b005b34801561092457600080fd5b5061093f600480360381019061093a9190613112565b612021565b005b34801561094d57600080fd5b5061096860048036038101906109639190613b34565b612085565b60405161097591906131df565b60405180910390f35b34801561098a57600080fd5b506109a560048036038101906109a09190613692565b612119565b005b3480156109b357600080fd5b506109bc6121d1565b6040516109c991906132ed565b60405180910390f35b3480156109de57600080fd5b506109f960048036038101906109f49190613112565b6121f7565b005b600e60009054906101000a900460ff1615610a1557600080fd5b601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160009054906101000a900460ff1615610a6f57600080fd5b600b8181548110610a8357610a82613b74565b5b906000526020600020906004020160020160009054906101000a900460ff1615610aac57600080fd5b601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160009054906101000a900460ff16610b0557600080fd5b80601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101819055506001601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160006101000a81548160ff021916908315150217905550600b8181548110610bbb57610bba613b74565b5b90600052602060002090600402016003016000815480929190610bdd90613bd2565b9190505550600c6000815480929190610bf590613bd2565b919050555050565b60007f80ac58cd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19161480610cc857507f5b5e139f000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b80610cd85750610cd78261225b565b5b9050919050565b606060008054610cee90613c49565b80601f0160208091040260200160405190810160405280929190818152602001828054610d1a90613c49565b8015610d675780601f10610d3c57610100808354040283529160200191610d67565b820191906000526020600020905b815481529060010190602001808311610d4a57829003601f168201915b5050505050905090565b6000610d7c826122c5565b6004600083815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b6000610dc282611373565b90508073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610e32576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e2990613cec565b60405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff16610e51612310565b73ffffffffffffffffffffffffffffffffffffffff161480610e805750610e7f81610e7a612310565b612085565b5b610ebf576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610eb690613d7e565b60405180910390fd5b610ec98383612318565b505050565b600c5481565b6000600b80549050905090565b600047905090565b60085481565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610f4957600080fd5b60008273ffffffffffffffffffffffffffffffffffffffff1682604051610f6f90613dcf565b60006040518083038185875af1925050503d8060008114610fac576040519150601f19603f3d011682016040523d82523d6000602084013e610fb1565b606091505b5050905080610fbf57600080fd5b505050565b610fd5610fcf612310565b826123d1565b611014576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161100b90613e56565b60405180910390fd5b61101f838383612466565b505050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461107e57600080fd5b600b60405180608001604052808481526020018381526020016000151581526020016000815250908060018154018082558091505060019003906000526020600020906004020160009091909190915060008201518160000190816110e39190614022565b5060208201518160010190816110f99190614022565b5060408201518160020160006101000a81548160ff0219169083151502179055506060820151816003015550505050565b60095481565b611138613074565b600b828154811061114c5761114b613b74565b5b906000526020600020906004020160405180608001604052908160008201805461117590613c49565b80601f01602080910402602001604051908101604052809291908181526020018280546111a190613c49565b80156111ee5780601f106111c3576101008083540402835291602001916111ee565b820191906000526020600020905b8154815290600101906020018083116111d157829003601f168201915b5050505050815260200160018201805461120790613c49565b80601f016020809104026020016040519081016040528092919081815260200182805461123390613c49565b80156112805780601f1061125557610100808354040283529160200191611280565b820191906000526020600020905b81548152906001019060200180831161126357829003601f168201915b505050505081526020016002820160009054906101000a900460ff161515151581526020016003820154815250509050919050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461130f57600080fd5b80600a60006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b61136e83838360405180602001604052806000815250611b16565b505050565b60008061137f8361275f565b9050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036113f0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016113e790614140565b60405180910390fd5b80915050919050565b60008073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603611469576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611460906141d2565b60405180910390fd5b600360008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6114b861309e565b600f60008381526020019081526020016000206040518060800160405290816000820180546114e690613c49565b80601f016020809104026020016040519081016040528092919081815260200182805461151290613c49565b801561155f5780601f106115345761010080835404028352916020019161155f565b820191906000526020600020905b81548152906001019060200180831161154257829003601f168201915b505050505081526020016001820154815260200160028201805461158290613c49565b80601f01602080910402602001604051908101604052809291908181526020018280546115ae90613c49565b80156115fb5780601f106115d0576101008083540402835291602001916115fb565b820191906000526020600020905b8154815290600101906020018083116115de57829003601f168201915b505050505081526020016003820160009054906101000a900460ff1615151515815250509050919050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461168057600080fd5b60001515600f600084815260200190815260200160002060030160009054906101000a900460ff161515146116b457600080fd5b80600f6000848152602001908152602001600020600101819055505050565b3373ffffffffffffffffffffffffffffffffffffffff166116f384611373565b73ffffffffffffffffffffffffffffffffffffffff161461171357600080fd5b60095434101561172257600080fd5b81600f600085815260200190815260200160002060000190816117459190614022565b5080600f600085815260200190815260200160002060020190816117699190614022565b50505050565b600a60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146117c957600080fd5b6000601060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160006101000a81548160ff02191690831515021790555050565b6000600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b600d5481565b60606001805461186690613c49565b80601f016020809104026020016040519081016040528092919081815260200182805461189290613c49565b80156118df5780601f106118b4576101008083540402835291602001916118df565b820191906000526020600020905b8154815290600101906020018083116118c257829003601f168201915b5050505050905090565b600081036118f657600080fd5b60075481111561190557600080fd5b60001515600f600083815260200190815260200160002060030160009054906101000a900460ff1615151461193957600080fd5b600f60008281526020019081526020016000206001015434101561195c57600080fd5b6001601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160006101000a81548160ff0219169083151502179055506001600f600083815260200190815260200160002060030160006101000a81548160ff021916908315150217905550600860008154809291906119f990613bd2565b9190505550611a08338261279c565b50565b611a1d611a16612310565b83836127ba565b5050565b60106020528060005260406000206000915090508060000160009054906101000a900460ff16908060010154908060020160009054906101000a900460ff16905083565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611abf57600080fd5b80600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600e60009054906101000a900460ff1681565b611b27611b21612310565b836123d1565b611b66576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611b5d90613e56565b60405180910390fd5b611b7284848484612926565b50505050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611bd257600080fd5b6000601060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160006101000a81548160ff02191690831515021790555050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611c8a57600080fd5b60076000815480929190611c9d90613bd2565b9190505550604051806080016040528084815260200183815260200182815260200160001515815250600f600060075481526020019081526020016000206000820151816000019081611cf09190614022565b50602082015181600101556040820151816002019081611d109190614022565b5060608201518160030160006101000a81548160ff021916908315150217905550905050505050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611d9357600080fd5b80600e60006101000a81548160ff02191690831515021790555050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611e0a57600080fd5b6000600c81905550565b60606000611e6c600f6000858152602001908152602001600020600001600f6000868152602001908152602001600020600201604051602001611e589291906143fc565b604051602081830303815290604052612982565b905080604051602001611e7f91906144d4565b604051602081830303815290604052915050919050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611ef057600080fd5b604051806080016040528084815260200183815260200182151581526020016000815250600b8581548110611f2857611f27613b74565b5b90600052602060002090600402016000820151816000019081611f4b9190614022565b506020820151816001019081611f619190614022565b5060408201518160020160006101000a81548160ff0219169083151502179055506060820151816003015590505050505050565b60075481565b600e60009054906101000a900460ff1615611fb557600080fd5b600d54341015611fc457600080fd5b6001601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160006101000a81548160ff021916908315150217905550565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461207b57600080fd5b80600d8190555050565b6000600560008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b600a60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461217357600080fd5b6001601060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160006101000a81548160ff02191690831515021790555050565b600a60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461225157600080fd5b8060098190555050565b60007f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916149050919050565b6122ce81612ae5565b61230d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161230490614140565b60405180910390fd5b50565b600033905090565b816004600083815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550808273ffffffffffffffffffffffffffffffffffffffff1661238b83611373565b73ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560405160405180910390a45050565b6000806123dd83611373565b90508073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16148061241f575061241e8185612085565b5b8061245d57508373ffffffffffffffffffffffffffffffffffffffff1661244584610d71565b73ffffffffffffffffffffffffffffffffffffffff16145b91505092915050565b8273ffffffffffffffffffffffffffffffffffffffff1661248682611373565b73ffffffffffffffffffffffffffffffffffffffff16146124dc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016124d390614568565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361254b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612542906145fa565b60405180910390fd5b6125588383836001612b26565b8273ffffffffffffffffffffffffffffffffffffffff1661257882611373565b73ffffffffffffffffffffffffffffffffffffffff16146125ce576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016125c590614568565b60405180910390fd5b6004600082815260200190815260200160002060006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556001600360008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825403925050819055506001600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540192505081905550816002600083815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550808273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60405160405180910390a461275a8383836001612c4c565b505050565b60006002600083815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b6127b6828260405180602001604052806000815250612c52565b5050565b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603612828576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161281f90614666565b60405180910390fd5b80600560008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c318360405161291991906131df565b60405180910390a3505050565b612931848484612466565b61293d84848484612cad565b61297c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612973906146f8565b60405180910390fd5b50505050565b606060008251036129a457604051806020016040528060008152509050612ae0565b60006040518060600160405280604081526020016149de60409139905060006003600285516129d39190614718565b6129dd919061477b565b60046129e991906147ac565b67ffffffffffffffff811115612a0257612a016133fb565b5b6040519080825280601f01601f191660200182016040528015612a345781602001600182028036833780820191505090505b509050600182016020820185865187015b80821015612aa0576003820191508151603f8160121c168501518453600184019350603f81600c1c168501518453600184019350603f8160061c168501518453600184019350603f8116850151845360018401935050612a45565b5050600386510660018114612abc5760028114612acf57612ad7565b603d6001830353603d6002830353612ad7565b603d60018303535b50505080925050505b919050565b60008073ffffffffffffffffffffffffffffffffffffffff16612b078361275f565b73ffffffffffffffffffffffffffffffffffffffff1614159050919050565b6001811115612c4657600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1614612bba5780600360008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254612bb291906147ee565b925050819055505b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614612c455780600360008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254612c3d9190614718565b925050819055505b5b50505050565b50505050565b612c5c8383612e34565b612c696000848484612cad565b612ca8576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612c9f906146f8565b60405180910390fd5b505050565b6000612cce8473ffffffffffffffffffffffffffffffffffffffff16613051565b15612e27578373ffffffffffffffffffffffffffffffffffffffff1663150b7a02612cf7612310565b8786866040518563ffffffff1660e01b8152600401612d199493929190614877565b6020604051808303816000875af1925050508015612d5557506040513d601f19601f82011682018060405250810190612d5291906148d8565b60015b612dd7573d8060008114612d85576040519150601f19603f3d011682016040523d82523d6000602084013e612d8a565b606091505b506000815103612dcf576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612dc6906146f8565b60405180910390fd5b805181602001fd5b63150b7a0260e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614915050612e2c565b600190505b949350505050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603612ea3576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612e9a90614951565b60405180910390fd5b612eac81612ae5565b15612eec576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612ee3906149bd565b60405180910390fd5b612efa600083836001612b26565b612f0381612ae5565b15612f43576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612f3a906149bd565b60405180910390fd5b6001600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540192505081905550816002600083815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550808273ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60405160405180910390a461304d600083836001612c4c565b5050565b6000808273ffffffffffffffffffffffffffffffffffffffff163b119050919050565b60405180608001604052806060815260200160608152602001600015158152602001600081525090565b60405180608001604052806060815260200160008152602001606081526020016000151581525090565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b6130ef816130dc565b81146130fa57600080fd5b50565b60008135905061310c816130e6565b92915050565b600060208284031215613128576131276130d2565b5b6000613136848285016130fd565b91505092915050565b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b6131748161313f565b811461317f57600080fd5b50565b6000813590506131918161316b565b92915050565b6000602082840312156131ad576131ac6130d2565b5b60006131bb84828501613182565b91505092915050565b60008115159050919050565b6131d9816131c4565b82525050565b60006020820190506131f460008301846131d0565b92915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015613234578082015181840152602081019050613219565b60008484015250505050565b6000601f19601f8301169050919050565b600061325c826131fa565b6132668185613205565b9350613276818560208601613216565b61327f81613240565b840191505092915050565b600060208201905081810360008301526132a48184613251565b905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006132d7826132ac565b9050919050565b6132e7816132cc565b82525050565b600060208201905061330260008301846132de565b92915050565b613311816132cc565b811461331c57600080fd5b50565b60008135905061332e81613308565b92915050565b6000806040838503121561334b5761334a6130d2565b5b60006133598582860161331f565b925050602061336a858286016130fd565b9150509250929050565b61337d816130dc565b82525050565b60006020820190506133986000830184613374565b92915050565b6000806000606084860312156133b7576133b66130d2565b5b60006133c58682870161331f565b93505060206133d68682870161331f565b92505060406133e7868287016130fd565b9150509250925092565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61343382613240565b810181811067ffffffffffffffff82111715613452576134516133fb565b5b80604052505050565b60006134656130c8565b9050613471828261342a565b919050565b600067ffffffffffffffff821115613491576134906133fb565b5b61349a82613240565b9050602081019050919050565b82818337600083830152505050565b60006134c96134c484613476565b61345b565b9050828152602081018484840111156134e5576134e46133f6565b5b6134f08482856134a7565b509392505050565b600082601f83011261350d5761350c6133f1565b5b813561351d8482602086016134b6565b91505092915050565b6000806040838503121561353d5761353c6130d2565b5b600083013567ffffffffffffffff81111561355b5761355a6130d7565b5b613567858286016134f8565b925050602083013567ffffffffffffffff811115613588576135876130d7565b5b613594858286016134f8565b9150509250929050565b600082825260208201905092915050565b60006135ba826131fa565b6135c4818561359e565b93506135d4818560208601613216565b6135dd81613240565b840191505092915050565b6135f1816131c4565b82525050565b613600816130dc565b82525050565b6000608083016000830151848203600086015261362382826135af565b9150506020830151848203602086015261363d82826135af565b915050604083015161365260408601826135e8565b50606083015161366560608601826135f7565b508091505092915050565b6000602082019050818103600083015261368a8184613606565b905092915050565b6000602082840312156136a8576136a76130d2565b5b60006136b68482850161331f565b91505092915050565b600060808301600083015184820360008601526136dc82826135af565b91505060208301516136f160208601826135f7565b506040830151848203604086015261370982826135af565b915050606083015161371e60608601826135e8565b508091505092915050565b6000602082019050818103600083015261374381846136bf565b905092915050565b60008060408385031215613762576137616130d2565b5b6000613770858286016130fd565b9250506020613781858286016130fd565b9150509250929050565b6000806000606084860312156137a4576137a36130d2565b5b60006137b2868287016130fd565b935050602084013567ffffffffffffffff8111156137d3576137d26130d7565b5b6137df868287016134f8565b925050604084013567ffffffffffffffff811115613800576137ff6130d7565b5b61380c868287016134f8565b9150509250925092565b61381f816131c4565b811461382a57600080fd5b50565b60008135905061383c81613816565b92915050565b60008060408385031215613859576138586130d2565b5b60006138678582860161331f565b92505060206138788582860161382d565b9150509250929050565b600060608201905061389760008301866131d0565b6138a46020830185613374565b6138b160408301846131d0565b949350505050565b600067ffffffffffffffff8211156138d4576138d36133fb565b5b6138dd82613240565b9050602081019050919050565b60006138fd6138f8846138b9565b61345b565b905082815260208101848484011115613919576139186133f6565b5b6139248482856134a7565b509392505050565b600082601f830112613941576139406133f1565b5b81356139518482602086016138ea565b91505092915050565b60008060008060808587031215613974576139736130d2565b5b60006139828782880161331f565b94505060206139938782880161331f565b93505060406139a4878288016130fd565b925050606085013567ffffffffffffffff8111156139c5576139c46130d7565b5b6139d18782880161392c565b91505092959194509250565b6000806000606084860312156139f6576139f56130d2565b5b600084013567ffffffffffffffff811115613a1457613a136130d7565b5b613a20868287016134f8565b9350506020613a31868287016130fd565b925050604084013567ffffffffffffffff811115613a5257613a516130d7565b5b613a5e868287016134f8565b9150509250925092565b600060208284031215613a7e57613a7d6130d2565b5b6000613a8c8482850161382d565b91505092915050565b60008060008060808587031215613aaf57613aae6130d2565b5b6000613abd878288016130fd565b945050602085013567ffffffffffffffff811115613ade57613add6130d7565b5b613aea878288016134f8565b935050604085013567ffffffffffffffff811115613b0b57613b0a6130d7565b5b613b17878288016134f8565b9250506060613b288782880161382d565b91505092959194509250565b60008060408385031215613b4b57613b4a6130d2565b5b6000613b598582860161331f565b9250506020613b6a8582860161331f565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000613bdd826130dc565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203613c0f57613c0e613ba3565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680613c6157607f821691505b602082108103613c7457613c73613c1a565b5b50919050565b7f4552433732313a20617070726f76616c20746f2063757272656e74206f776e6560008201527f7200000000000000000000000000000000000000000000000000000000000000602082015250565b6000613cd6602183613205565b9150613ce182613c7a565b604082019050919050565b60006020820190508181036000830152613d0581613cc9565b9050919050565b7f4552433732313a20617070726f76652063616c6c6572206973206e6f7420746f60008201527f6b656e206f776e6572206f7220617070726f76656420666f7220616c6c000000602082015250565b6000613d68603d83613205565b9150613d7382613d0c565b604082019050919050565b60006020820190508181036000830152613d9781613d5b565b9050919050565b600081905092915050565b50565b6000613db9600083613d9e565b9150613dc482613da9565b600082019050919050565b6000613dda82613dac565b9150819050919050565b7f4552433732313a2063616c6c6572206973206e6f7420746f6b656e206f776e6560008201527f72206f7220617070726f76656400000000000000000000000000000000000000602082015250565b6000613e40602d83613205565b9150613e4b82613de4565b604082019050919050565b60006020820190508181036000830152613e6f81613e33565b9050919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302613ed87fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82613e9b565b613ee28683613e9b565b95508019841693508086168417925050509392505050565b6000819050919050565b6000613f1f613f1a613f15846130dc565b613efa565b6130dc565b9050919050565b6000819050919050565b613f3983613f04565b613f4d613f4582613f26565b848454613ea8565b825550505050565b600090565b613f62613f55565b613f6d818484613f30565b505050565b5b81811015613f9157613f86600082613f5a565b600181019050613f73565b5050565b601f821115613fd657613fa781613e76565b613fb084613e8b565b81016020851015613fbf578190505b613fd3613fcb85613e8b565b830182613f72565b50505b505050565b600082821c905092915050565b6000613ff960001984600802613fdb565b1980831691505092915050565b60006140128383613fe8565b9150826002028217905092915050565b61402b826131fa565b67ffffffffffffffff811115614044576140436133fb565b5b61404e8254613c49565b614059828285613f95565b600060209050601f83116001811461408c576000841561407a578287015190505b6140848582614006565b8655506140ec565b601f19841661409a86613e76565b60005b828110156140c25784890151825560018201915060208501945060208101905061409d565b868310156140df57848901516140db601f891682613fe8565b8355505b6001600288020188555050505b505050505050565b7f4552433732313a20696e76616c696420746f6b656e2049440000000000000000600082015250565b600061412a601883613205565b9150614135826140f4565b602082019050919050565b600060208201905081810360008301526141598161411d565b9050919050565b7f4552433732313a2061646472657373207a65726f206973206e6f74206120766160008201527f6c6964206f776e65720000000000000000000000000000000000000000000000602082015250565b60006141bc602983613205565b91506141c782614160565b604082019050919050565b600060208201905081810360008301526141eb816141af565b9050919050565b600081905092915050565b7f7b226e616d65223a202200000000000000000000000000000000000000000000600082015250565b6000614233600a836141f2565b915061423e826141fd565b600a82019050919050565b6000815461425681613c49565b61426081866141f2565b9450600182166000811461427b5760018114614290576142c3565b60ff19831686528115158202860193506142c3565b61429985613e76565b60005b838110156142bb5781548189015260018201915060208101905061429c565b838801955050505b50505092915050565b7f222c000000000000000000000000000000000000000000000000000000000000600082015250565b60006143026002836141f2565b915061430d826142cc565b600282019050919050565b7f22696d616765223a202200000000000000000000000000000000000000000000600082015250565b600061434e600a836141f2565b915061435982614318565b600a82019050919050565b7f2200000000000000000000000000000000000000000000000000000000000000600082015250565b600061439a6001836141f2565b91506143a582614364565b600182019050919050565b7f7d00000000000000000000000000000000000000000000000000000000000000600082015250565b60006143e66001836141f2565b91506143f1826143b0565b600182019050919050565b600061440782614226565b91506144138285614249565b915061441e826142f5565b915061442982614341565b91506144358284614249565b91506144408261438d565b915061444b826143d9565b91508190509392505050565b7f646174613a6170706c69636174696f6e2f6a736f6e3b6261736536342c000000600082015250565b600061448d601d836141f2565b915061449882614457565b601d82019050919050565b60006144ae826131fa565b6144b881856141f2565b93506144c8818560208601613216565b80840191505092915050565b60006144df82614480565b91506144eb82846144a3565b915081905092915050565b7f4552433732313a207472616e736665722066726f6d20696e636f72726563742060008201527f6f776e6572000000000000000000000000000000000000000000000000000000602082015250565b6000614552602583613205565b915061455d826144f6565b604082019050919050565b6000602082019050818103600083015261458181614545565b9050919050565b7f4552433732313a207472616e7366657220746f20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b60006145e4602483613205565b91506145ef82614588565b604082019050919050565b60006020820190508181036000830152614613816145d7565b9050919050565b7f4552433732313a20617070726f766520746f2063616c6c657200000000000000600082015250565b6000614650601983613205565b915061465b8261461a565b602082019050919050565b6000602082019050818103600083015261467f81614643565b9050919050565b7f4552433732313a207472616e7366657220746f206e6f6e20455243373231526560008201527f63656976657220696d706c656d656e7465720000000000000000000000000000602082015250565b60006146e2603283613205565b91506146ed82614686565b604082019050919050565b60006020820190508181036000830152614711816146d5565b9050919050565b6000614723826130dc565b915061472e836130dc565b925082820190508082111561474657614745613ba3565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000614786826130dc565b9150614791836130dc565b9250826147a1576147a061474c565b5b828204905092915050565b60006147b7826130dc565b91506147c2836130dc565b92508282026147d0816130dc565b915082820484148315176147e7576147e6613ba3565b5b5092915050565b60006147f9826130dc565b9150614804836130dc565b925082820390508181111561481c5761481b613ba3565b5b92915050565b600081519050919050565b600082825260208201905092915050565b600061484982614822565b614853818561482d565b9350614863818560208601613216565b61486c81613240565b840191505092915050565b600060808201905061488c60008301876132de565b61489960208301866132de565b6148a66040830185613374565b81810360608301526148b8818461483e565b905095945050505050565b6000815190506148d28161316b565b92915050565b6000602082840312156148ee576148ed6130d2565b5b60006148fc848285016148c3565b91505092915050565b7f4552433732313a206d696e7420746f20746865207a65726f2061646472657373600082015250565b600061493b602083613205565b915061494682614905565b602082019050919050565b6000602082019050818103600083015261496a8161492e565b9050919050565b7f4552433732313a20746f6b656e20616c7265616479206d696e74656400000000600082015250565b60006149a7601c83613205565b91506149b282614971565b602082019050919050565b600060208201905081810360008301526149d68161499a565b905091905056fe4142434445464748494a4b4c4d4e4f505152535455565758595a6162636465666768696a6b6c6d6e6f707172737475767778797a303132333435363738392b2fa2646970667358221220fb8ecdf6678d0fc807635e764dc4b1c82c03012f9f4eb4915b60bcf840387bf864736f6c63430008120033";
    let extractor = common::new_extractor_from_bytecode(bytecode, LazyWatchdog.in_rc())?;

    // Get the final storage layout for the input contract
    let layout = extractor.analyze()?;

    // We should see 17 slots, but we see 18
    assert_eq!(layout.slot_count(), 18);

    // `string` but we infer `bytes`
    assert!(layout.has_slot(0, 0, AbiType::DynBytes));

    // `string` but we infer `bytes`
    assert!(layout.has_slot(1, 0, AbiType::DynBytes));

    // `mapping(uint256 => address)`
    assert!(layout.has_slot(
        2,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::UInt { size: Some(256) }),
            value_type: Box::new(AbiType::Address),
        }
    ));

    // `mapping(address => uint256)` but we infer `mapping(address => uintUnknown)`
    assert!(layout.has_slot(
        3,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::Address),
            value_type: Box::new(AbiType::UInt { size: None }),
        }
    ));

    // `mapping(uint256 => address)` but we infer `mapping(uint256 => number160)`
    assert!(layout.has_slot(
        4,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::UInt { size: Some(256) }),
            value_type: Box::new(AbiType::Number { size: Some(160) }),
        }
    ));

    // `mapping(address => mapping(address => bool))` but we infer `mapping(address
    // => mapping(address => struct(bytes1, bytes31)))`
    assert!(layout.has_slot(
        5,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::Address),
            value_type: Box::new(AbiType::Mapping {
                key_type:   Box::new(AbiType::Address),
                value_type: Box::new(AbiType::Struct {
                    elements: vec![
                        StructElement::new(0, AbiType::Bytes { length: Some(1) }),
                        StructElement::new(8, AbiType::Bytes { length: Some(31) }),
                    ],
                }),
            }),
        }
    ));

    // `address` but we infer `bytes20`
    assert!(layout.has_slot(6, 0, AbiType::Bytes { length: Some(20) }));

    // `uint256`
    assert!(layout.has_slot(7, 0, AbiType::UInt { size: Some(256) }));

    // `uint256` but we infer `numberUnknown`
    assert!(layout.has_slot(8, 0, AbiType::Number { size: None }));

    // `uint256`
    assert!(layout.has_slot(9, 0, AbiType::UInt { size: Some(256) }));

    // `address` but we infer `bytes20`
    assert!(layout.has_slot(10, 0, AbiType::Bytes { length: Some(20) }));

    // `struct(string, string, bool, uint256)[]` but we infer `uintUnknown`
    assert!(layout.has_slot(11, 0, AbiType::UInt { size: None }));

    // `uint256` but we infer `numberUnknown`
    assert!(layout.has_slot(12, 0, AbiType::Number { size: None }));

    // `uint256`
    assert!(layout.has_slot(13, 0, AbiType::UInt { size: Some(256) }));

    // `bool` but we infer `packed(bytes1, bytes31)`
    assert!(layout.has_slot(14, 0, AbiType::Bytes { length: Some(1) }));
    assert!(layout.has_slot(14, 8, AbiType::Bytes { length: Some(31) }));

    // `mapping(uint256 => struct(string, uint256, string))` but we infer
    // `mapping(uint256 => struct(bytes, uint256, bytes, bytes31))`
    assert!(layout.has_slot(
        15,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::UInt { size: Some(256) }),
            value_type: Box::new(AbiType::Struct {
                elements: vec![
                    StructElement::new(0, AbiType::DynBytes),
                    StructElement::new(256, AbiType::UInt { size: Some(256) }),
                    StructElement::new(512, AbiType::DynBytes),
                    StructElement::new(776, AbiType::Bytes { length: Some(31) })
                ],
            }),
        }
    ));

    // `mapping(address => struct(bool, uint256, bool))` but we infer
    // `mapping(address => struct(bytes1, bytes31, uint256, bytes31))`
    assert!(layout.has_slot(
        16,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::Address),
            value_type: Box::new(AbiType::Struct {
                elements: vec![
                    StructElement::new(0, AbiType::Bytes { length: Some(1) }),
                    StructElement::new(8, AbiType::Bytes { length: Some(31) }),
                    StructElement::new(256, AbiType::UInt { size: Some(256) }),
                    StructElement::new(520, AbiType::Bytes { length: Some(31) })
                ],
            }),
        }
    ));

    Ok(())
}
