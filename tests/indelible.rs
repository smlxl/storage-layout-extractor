//! This module tests the library's analysis capabilities on the `Indelible`
//! contract.
#![cfg(test)]

use std::str::FromStr;

use ethnum::U256;
use storage_layout_analyzer::{
    inference::abi::{AbiType, StructElement},
    watchdog::LazyWatchdog,
};

mod common;

/// Tests the analyser on the bytecode of the Indelible contract deployed
/// [here](https://etherscan.io/address/0x17e4af31838c470b350559c6369a609ba638beee).
#[test]
fn correctly_generates_a_layout() -> anyhow::Result<()> {
    // Create the analyzer
    let bytecode = "0x60806040526004361061036f5760003560e01c80636cced73a116101c6578063b88d4fde116100f7578063dc53fd9211610095578063e985e9c51161006f578063e985e9c5146109ee578063ea84b59b14610a37578063f2fde38b14610a64578063fd6b3cf514610a8457600080fd5b8063dc53fd9214610996578063dc9867ce146109ac578063e8a3d485146109d957600080fd5b8063c87b56dd116100d1578063c87b56dd14610920578063d36c2f2614610940578063d5abeb0114610960578063dbe9875f1461097657600080fd5b8063b88d4fde146108cd578063ba41b0c6146108ed578063c11feac11461090057600080fd5b80638da5cb5b11610164578063a22cb4651161013e578063a22cb46514610857578063a24e515314610877578063b32c56801461088d578063b4568066146108ad57600080fd5b80638da5cb5b1461080f5780638fb4e8a91461082d57806395d89b411461084257600080fd5b8063715018a6116101a0578063715018a61461079a5780637bddd65b146107af5780637cb64759146107cf57806389ce3074146107ef57600080fd5b80636cced73a1461073a5780636df9fa881461075a57806370a082311461077a57600080fd5b806342842e0e116102a057806361ab9d0c1161023e578063639814e011610218578063639814e0146106da57806366e33870146106f057806368bd580e146107105780636c0360eb1461072557600080fd5b806361ab9d0c1461067a578063621a1f741461069a5780636352211e146106ba57600080fd5b8063542d50411161027a578063542d50411461060b57806355f804b3146106255780635b92ac0d146106455780636190e1da1461065a57600080fd5b806342842e0e146105b65780634920154b146105d65780634ca1a0f2146105eb57600080fd5b806323b872dd1161030d57806336cd2edd116102e757806336cd2edd1461054e5780633cca2420146105645780633ccfd60b1461058c5780634047638d146105a157600080fd5b806323b872dd146104fa57806329fc6bae1461051a5780632d6b62241461053457600080fd5b8063095ea7b311610349578063095ea7b31461047757806309dbabca146104975780630f3debbe146104b757806318160ddd146104d757600080fd5b806301ffc9a7146103e857806306fdde031461041d578063081812fc1461043f57600080fd5b366103e357601d5460ff166103cb5760405162461bcd60e51b815260206004820152601c60248201527f5075626c6963206d696e74696e67206973206e6f74206163746976650000000060448201526064015b60405180910390fd5b6103e1601b54346103dc9190614059565b610aa4565b005b600080fd5b3480156103f457600080fd5b50610408610403366004614083565b610d18565b60405190151581526020015b60405180910390f35b34801561042957600080fd5b50610432610d6a565b60405161041491906140f8565b34801561044b57600080fd5b5061045f61045a36600461410b565b610dfc565b6040516001600160a01b039091168152602001610414565b34801561048357600080fd5b506103e161049236600461413b565b610e40565b3480156104a357600080fd5b506104326104b2366004614165565b610ee0565b3480156104c357600080fd5b506103e16104d23660046142a8565b610f28565b3480156104e357600080fd5b50600154600054035b604051908152602001610414565b34801561050657600080fd5b506103e16105153660046143d2565b611028565b34801561052657600080fd5b506021546104089060ff1681565b34801561054057600080fd5b50601d546104089060ff1681565b34801561055a57600080fd5b506104ec60205481565b34801561057057600080fd5b506105796111dc565b604051610414979695949392919061440e565b34801561059857600080fd5b506103e161153a565b3480156105ad57600080fd5b506103e1611635565b3480156105c257600080fd5b506103e16105d13660046143d2565b611673565b3480156105e257600080fd5b506103e1611693565b3480156105f757600080fd5b506103e161060636600461410b565b6116d1565b34801561061757600080fd5b506019546104089060ff1681565b34801561063157600080fd5b506103e1610640366004614497565b611700565b34801561065157600080fd5b50610408611741565b34801561066657600080fd5b506103e1610675366004614497565b61176f565b34801561068657600080fd5b506103e16106953660046145ac565b6117cf565b3480156106a657600080fd5b506104326106b536600461410b565b611aa1565b3480156106c657600080fd5b5061045f6106d536600461410b565b611e8d565b3480156106e657600080fd5b506104ec601a5481565b3480156106fc57600080fd5b5061043261070b366004614497565b611e98565b34801561071c57600080fd5b506103e1611ff4565b34801561073157600080fd5b50610432612050565b34801561074657600080fd5b50610408610755366004614165565b6120de565b34801561076657600080fd5b506103e161077536600461410b565b6120fa565b34801561078657600080fd5b506104ec61079536600461466d565b612129565b3480156107a657600080fd5b506103e1612177565b3480156107bb57600080fd5b506103e16107ca36600461410b565b6121ad565b3480156107db57600080fd5b506103e16107ea36600461410b565b6121dc565b3480156107fb57600080fd5b5061043261080a366004614497565b61220b565b34801561081b57600080fd5b506009546001600160a01b031661045f565b34801561083957600080fd5b506103e1612424565b34801561084e57600080fd5b50610432612462565b34801561086357600080fd5b506103e1610872366004614688565b612471565b34801561088357600080fd5b506104ec601f5481565b34801561089957600080fd5b506104086108a8366004614706565b612506565b3480156108b957600080fd5b506103e16108c83660046147be565b612586565b3480156108d957600080fd5b506103e16108e83660046148c9565b612715565b6104ec6108fb366004614930565b612759565b34801561090c57600080fd5b5061043261091b36600461410b565b612962565b34801561092c57600080fd5b5061043261093b36600461410b565b612970565b34801561094c57600080fd5b506103e161095b366004614962565b612bee565b34801561096c57600080fd5b506104ec61097481565b34801561098257600080fd5b506103e16109913660046149b1565b612dc4565b3480156109a257600080fd5b506104ec601b5481565b3480156109b857600080fd5b506109cc6109c7366004614165565b612e64565b60405161041491906149d4565b3480156109e557600080fd5b50610432612ecf565b3480156109fa57600080fd5b50610408610a09366004614a18565b6001600160a01b03918216600090815260076020908152604080832093909416825291909152205460ff1690565b348015610a4357600080fd5b50610a57610a52366004614165565b612f2d565b6040516104149190614a42565b348015610a7057600080fd5b506103e1610a7f36600461466d565b61308f565b348015610a9057600080fd5b506103e1610a9f366004614165565b61312a565b6000610aae611741565b610af25760405162461bcd60e51b81526020600482015260156024820152744d696e74696e67206973206e6f742061637469766560581b60448201526064016103c2565b60005482610b385760405162461bcd60e51b8152602060048201526013602482015272125b9d985b1a59081d1bdad95b8818dbdd5b9d606a1b60448201526064016103c2565b610974610b458483614a84565b1115610b895760405162461bcd60e51b8152602060048201526013602482015272416c6c20746f6b656e732061726520676f6e6560681b60448201526064016103c2565b601d5460ff1615610cb6576009546001600160a01b03163314610c1f57601a5433600090815260056020526040908190205485911c6001600160401b0316610bd19190614a84565b1115610c1f5760405162461bcd60e51b815260206004820152601a60248201527f4578636565646564206d6178206d696e747320616c6c6f77656400000000000060448201526064016103c2565b333214610c5a5760405162461bcd60e51b8152602060048201526009602482015268454f4173206f6e6c7960b81b60448201526064016103c2565b34601b5484610c699190614a9c565b14610cb65760405162461bcd60e51b815260206004820152601e60248201527f496e636f727265637420616d6f756e74206f662065746865722073656e74000060448201526064016103c2565b6000610cc3601485614059565b90506000610cd2601486614abb565b905060005b82811015610cfc57610cea3360146132a9565b80610cf481614acf565b915050610cd7565b508015610d0d57610d0d33826132a9565b50909150505b919050565b60006301ffc9a760e01b6001600160e01b031983161480610d4957506380ac58cd60e01b6001600160e01b03198316145b80610d645750635b5e139f60e01b6001600160e01b03198316145b92915050565b606060028054610d7990614ae8565b80601f0160208091040260200160405190810160405280929190818152602001828054610da590614ae8565b8015610df25780601f10610dc757610100808354040283529160200191610df2565b820191906000526020600020905b815481529060010190602001808311610dd557829003601f168201915b5050505050905090565b6000610e07826133aa565b610e24576040516333d1c03960e21b815260040160405180910390fd5b506000908152600660205260409020546001600160a01b031690565b6000610e4b82611e8d565b9050336001600160a01b03821614610e8457610e678133610a09565b610e84576040516367d9dca160e11b815260040160405180910390fd5b60008281526006602052604080822080546001600160a01b0319166001600160a01b0387811691821790925591518593918516917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92591a4505050565b6000828152600a602052604090208054606091610f219184908110610f0757610f07614b1c565b6000918252602090912001546001600160a01b03166133d1565b9392505050565b6009546001600160a01b03163314610f525760405162461bcd60e51b81526004016103c290614b32565b60195460ff1615610f755760405162461bcd60e51b81526004016103c290614b67565b805180518291602291610f8f918391602090910190613f05565b506020828101518051610fa89260018501920190613f05565b5060408201518051610fc4916002840191602090910190613f05565b5060608201518051610fe0916003840191602090910190613f05565b5060808201518051610ffc916004840191602090910190613f05565b5060a0820151600582015560c08201518051611022916006840191602090910190613f05565b50505050565b6000611033826133e1565b9050836001600160a01b0316816001600160a01b0316146110665760405162a1148160e81b815260040160405180910390fd5b60008281526006602052604090208054338082146001600160a01b038816909114176110b3576110968633610a09565b6110b357604051632ce44b5f60e11b815260040160405180910390fd5b6001600160a01b0385166110da57604051633a954ecd60e21b815260040160405180910390fd5b80156110e557600082555b6001600160a01b0380871660009081526005602052604080822080546000190190559187168152208054600101905561113e85611123888287613448565b600160e11b174260a01b176001600160a01b03919091161790565b600085815260046020526040812091909155600160e11b84169003611193576001840160008181526004602052604081205490036111915760005481146111915760008181526004602052604090208490555b505b83856001600160a01b0316876001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60405160405180910390a4505050505050565b6022805481906111eb90614ae8565b80601f016020809104026020016040519081016040528092919081815260200182805461121790614ae8565b80156112645780601f1061123957610100808354040283529160200191611264565b820191906000526020600020905b81548152906001019060200180831161124757829003601f168201915b50505050509080600101805461127990614ae8565b80601f01602080910402602001604051908101604052809291908181526020018280546112a590614ae8565b80156112f25780601f106112c7576101008083540402835291602001916112f2565b820191906000526020600020905b8154815290600101906020018083116112d557829003601f168201915b50505050509080600201805461130790614ae8565b80601f016020809104026020016040519081016040528092919081815260200182805461133390614ae8565b80156113805780601f1061135557610100808354040283529160200191611380565b820191906000526020600020905b81548152906001019060200180831161136357829003601f168201915b50505050509080600301805461139590614ae8565b80601f01602080910402602001604051908101604052809291908181526020018280546113c190614ae8565b801561140e5780601f106113e35761010080835404028352916020019161140e565b820191906000526020600020905b8154815290600101906020018083116113f157829003601f168201915b50505050509080600401805461142390614ae8565b80601f016020809104026020016040519081016040528092919081815260200182805461144f90614ae8565b801561149c5780601f106114715761010080835404028352916020019161149c565b820191906000526020600020905b81548152906001019060200180831161147f57829003601f168201915b5050505050908060050154908060060180546114b790614ae8565b80601f01602080910402602001604051908101604052809291908181526020018280546114e390614ae8565b80156115305780601f1061150557610100808354040283529160200191611530565b820191906000526020600020905b81548152906001019060200180831161151357829003601f168201915b5050505050905087565b6009546001600160a01b031633146115645760405162461bcd60e51b81526004016103c290614b32565b6002600854036115b65760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c0060448201526064016103c2565b60026008554760006127106115cc60fa82614b93565b6115d69084614a9c565b6115e09190614059565b905060006115f66009546001600160a01b031690565b905073ea208da933c43857683c04bc76e3fd331d7bfdf7611617828461346b565b61162a816116258587614b93565b61346b565b505060016008555050565b6009546001600160a01b0316331461165f5760405162461bcd60e51b81526004016103c290614b32565b601d805460ff19811660ff90911615179055565b61168e83838360405180602001604052806000815250612715565b505050565b6009546001600160a01b031633146116bd5760405162461bcd60e51b81526004016103c290614b32565b6017805460ff19811660ff90911615179055565b6009546001600160a01b031633146116fb5760405162461bcd60e51b81526004016103c290614b32565b602055565b6009546001600160a01b0316331461172a5760405162461bcd60e51b81526004016103c290614b32565b805161173d90601c906020840190613f05565b5050565b600061097461174f60005490565b10801561176a5750601d5460ff168061176a575060215460ff165b905090565b6009546001600160a01b031633146117995760405162461bcd60e51b81526004016103c290614b32565b60195460ff16156117bc5760405162461bcd60e51b81526004016103c290614b67565b805161173d906018906020840190613f05565b6009546001600160a01b031633146117f95760405162461bcd60e51b81526004016103c290614b32565b60195460ff161561181c5760405162461bcd60e51b81526004016103c290614b67565b8051600e836008811061183157611831614b1c565b0154146118985760405162461bcd60e51b815260206004820152602f60248201527f5472616974732073697a6520646f6573206e6f74206d6174636820746965727360448201526e040ccdee440e8d0d2e640d2dcc8caf608b1b60648201526084016103c2565b600081516001600160401b038111156118b3576118b3614187565b6040519080825280602002602001820160405280156118dc578160200160208202803683370190505b50905060005b8251811015611a81578281815181106118fd576118fd614b1c565b6020026020010151606001511561197c578183828151811061192157611921614b1c565b6020026020010151608001518151811061193d5761193d614b1c565b602002602001015182828151811061195757611957614b1c565b60200260200101906001600160a01b031690816001600160a01b0316815250506119d5565b6119a283828151811061199157611991614b1c565b602002602001015160400151613584565b8282815181106119b4576119b4614b1c565b60200260200101906001600160a01b031690816001600160a01b0316815250505b60405180604001604052808483815181106119f2576119f2614b1c565b6020026020010151600001518152602001848381518110611a1557611a15614b1c565b6020908102919091018101518101519091526000868152600b8252604080822085835283529020825180519192611a5192849290910190613f05565b506020828101518051611a6a9260018501920190613f05565b509050508080611a7990614acf565b9150506118e2565b506000838152600a60209081526040909120825161102292840190613f89565b6060611aac826133aa565b611ae85760405162461bcd60e51b815260206004820152600d60248201526c24b73b30b634b2103a37b5b2b760991b60448201526064016103c2565b6000611b16611af960086004614a9c565b604080518281016060018252910181526000602090910190815290565b6040805160088082526101208201909252919250600091906020820161010080368337505060408051600880825261012082019092529293506000929150602082016101008036833701905050905060005b6008811015611d5b576000838281518110611b8557611b85614b1c565b60200260200101519050828281518110611ba157611ba1614b1c565b602002602001015115156000151503611c47576000610974611bc2896135e9565b89611bcd8682614a84565b60405160e89390931b6001600160e81b0319166020840152602383019190915260438201526063016040516020818303038152906040528051906020012060001c611c189190614abb565b9050611c2481846135fe565b915081858481518110611c3957611c39614b1c565b602002602001018181525050505b6000828152600d6020908152604080832084845290915290205415611d48576000828152600d60209081526040808320848452909152902080546001908110611c9257611c92614b1c565b6000918252602080832090910154848352600d82526040808420858552909252908220805491928792611cc757611cc7614b1c565b906000526020600020015481518110611ce257611ce2614b1c565b6020908102919091018101919091526000838152600d825260408082208483529092529081208054600192869291611d1c57611d1c614b1c565b906000526020600020015481518110611d3757611d37614b1c565b911515602092830291909101909101525b5080611d5381614acf565b915050611b68565b5060005b8251811015611e8357600a838281518110611d7c57611d7c614b1c565b60200260200101511015611db357604080518082019091526002815261030360f41b6020820152611dae90859061369a565b611df8565b6064838281518110611dc757611dc7614b1c565b60200260200101511015611df8576040805180820190915260018152600360fc1b6020820152611df890859061369a565b6103e7838281518110611e0d57611e0d614b1c565b60200260200101511115611e455760408051808201909152600381526239393960e81b6020820152611e4090859061369a565b611e71565b611e71611e6a848381518110611e5d57611e5d614b1c565b602002602001015161371f565b859061369a565b80611e7b81614acf565b915050611d5f565b5091949350505050565b6000610d64826133e1565b60408051620200608101825262020040815260006020918201908152825180840190935260018352605b60f81b91830191909152606091611eda90829061369a565b60005b6008811015611fed576000611f1a611f1586611efa856003614a9c565b611f05866003614a9c565b611f10906003614a84565b61376e565b61383a565b60ff169050611f7d60168381548110611f3557611f35614b1c565b60009182526020808320868452600b825260408085208786528352938490209351611f669493909101929101614c43565b60408051601f19818403018152919052849061369a565b611f8960016008614b93565b8203611fb7576040805180820190915260018152605d60f81b6020820152611fb290849061369a565b611fda565b6040805180820190915260018152600b60fa1b6020820152611fda90849061369a565b5080611fe581614acf565b915050611edd565b5092915050565b60195460ff16156120175760405162461bcd60e51b81526004016103c290614b67565b6009546001600160a01b031633146120415760405162461bcd60e51b81526004016103c290614b32565b6019805460ff19166001179055565b601c805461205d90614ae8565b80601f016020809104026020016040519081016040528092919081815260200182805461208990614ae8565b80156120d65780601f106120ab576101008083540402835291602001916120d6565b820191906000526020600020905b8154815290600101906020018083116120b957829003601f168201915b505050505081565b6000610f216120ec84611aa1565b6120f584611aa1565b6138f8565b6009546001600160a01b031633146121245760405162461bcd60e51b81526004016103c290614b32565b601f55565b60006001600160a01b038216612152576040516323d3ad8160e21b815260040160405180910390fd5b506001600160a01b03166000908152600560205260409020546001600160401b031690565b6009546001600160a01b031633146121a15760405162461bcd60e51b81526004016103c290614b32565b6121ab6000613951565b565b6009546001600160a01b031633146121d75760405162461bcd60e51b81526004016103c290614b32565b601a55565b6009546001600160a01b031633146122065760405162461bcd60e51b81526004016103c290614b32565b601e55565b60408051620200608101909152620200408152600060209091018181526060919061224f6040518060c001604052806081815260200161543960819139829061369a565b61227b60186040516020016122649190614c99565b60408051601f19818403018152919052829061369a565b60005b61228a60016008614b93565b811015612346576122ae611f15866122a3846003614a9c565b611f05856003614a9c565b60ff169250612334600b6000838152602001908152602001600020600085815260200190815260200160002060010161230c612307600a60008681526020019081526020016000208781548110610f0757610f07614b1c565b6139a3565b60405160200161231d929190614ccb565b60408051601f19818403018152919052839061369a565b8061233e81614acf565b91505061227e565b50612371611f1585600361235b600882614a9c565b6123659190614b93565b611f1060086003614a9c565b60ff1691506123f3600b600061238960016008614b93565b815260200190815260200160002060008481526020019081526020016000206001016123e2612307600a6000600160086123c39190614b93565b81526020019081526020016000208681548110610f0757610f07614b1c565b604051602001612264929190614d25565b6123fc816139a3565b60405160200161240c9190614e89565b60405160208183030381529060405292505050919050565b6009546001600160a01b0316331461244e5760405162461bcd60e51b81526004016103c290614b32565b6021805460ff19811660ff90911615179055565b606060038054610d7990614ae8565b336001600160a01b0383160361249a5760405163b06307db60e01b815260040160405180910390fd5b3360008181526007602090815260408083206001600160a01b03871680855290835292819020805460ff191686151590811790915590519081529192917f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a35050565b600061257e83838080602002602001604051908101604052809392919081815260200183836020028082843760009201919091525050601e546040516bffffffffffffffffffffffff1960608b901b166020820152909250603401905060405160208183030381529060405280519060200120613af5565b949350505050565b6009546001600160a01b031633146125b05760405162461bcd60e51b81526004016103c290614b32565b60195460ff16156125d35760405162461bcd60e51b81526004016103c290614b67565b60005b815181101561173d5760405180604001604052808383815181106125fc576125fc614b1c565b60200260200101516020015160008151811061261a5761261a614b1c565b6020026020010151815260200183838151811061263957612639614b1c565b60200260200101516020015160018151811061265757612657614b1c565b6020026020010151815250600d600084848151811061267857612678614b1c565b60200260200101516000015160008151811061269657612696614b1c565b6020026020010151815260200190815260200160002060008484815181106126c0576126c0614b1c565b6020026020010151600001516001815181106126de576126de614b1c565b60200260200101518152602001908152602001600020906002612702929190613fde565b508061270d81614acf565b9150506125d6565b612720848484611028565b6001600160a01b0383163b156110225761273c84848484613b0b565b611022576040516368d2bf6b60e11b815260040160405180910390fd5b60006002600854036127ad5760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c0060448201526064016103c2565b60026008556127ba611741565b6127fe5760405162461bcd60e51b81526020600482015260156024820152744d696e74696e67206973206e6f742061637469766560581b60448201526064016103c2565b601d5460ff16612949576009546001600160a01b031633146128ed57612825338484612506565b6128655760405162461bcd60e51b8152602060048201526011602482015270139bdd081bdb88185b1b1bddc81b1a5cdd607a1b60448201526064016103c2565b60205484612895336001600160a01b03166000908152600560205260409081902054901c6001600160401b031690565b61289f9190614a84565b11156128ed5760405162461bcd60e51b815260206004820152601a60248201527f4578636565646564206d6178206d696e747320616c6c6f77656400000000000060448201526064016103c2565b34601f54856128fc9190614a9c565b146129495760405162461bcd60e51b815260206004820152601e60248201527f496e636f727265637420616d6f756e74206f662065746865722073656e74000060448201526064016103c2565b600061295485610aa4565b600160085595945050505050565b6060610d6461080a83611aa1565b606061297b826133aa565b6129b75760405162461bcd60e51b815260206004820152600d60248201526c24b73b30b634b2103a37b5b2b760991b60448201526064016103c2565b60008052600a6020527f13da86008ba1c6922daee3e07db95305ef49ebced9f5467a0b8613fcc6b343e354612a2e5760405162461bcd60e51b815260206004820152601a60248201527f5472616974732068617665206e6f74206265656e20616464656400000000000060448201526064016103c2565b6000612a3983611aa1565b604080516202006081018252620200408152600060209182019081528251808401909352601f83527f7b226e616d65223a22426c6f636b65644865616473204f6e436861696e20230091830191909152919250612a9790829061369a565b612ab6612aa38561371f565b6040516122649190602390602001614ece565b6000601c8054612ac590614ae8565b9050118015612ae257506000848152600c602052604090205460ff165b15612b0d57612b08601c612af58661371f565b8460405160200161226493929190614f1c565b612bb9565b60408051602081019091526000815260175460ff1615612b97576000612b328461220b565b9050612b5c81604051602001612b489190614f97565b6040516020818303038152906040526139a3565b604051602001612b6c9190614e89565b6040516020818303038152906040529150612b9181604051602001611f669190615082565b50612ba3565b612ba08361220b565b90505b612bb78160405160200161231d91906150c9565b505b612bd5612bc583611e98565b604051602001612264919061510c565b612bde816139a3565b60405160200161240c919061514d565b6009546001600160a01b03163314612c185760405162461bcd60e51b81526004016103c290614b32565b60195460ff1615612c3b5760405162461bcd60e51b81526004016103c290614b67565b60408051808201825282518152602080840151818301526000868152600b82528381208682528252929092208151805192939192612c7c9284920190613f05565b506020828101518051612c959260018501920190613f05565b5050506000838152600a6020908152604080832080548251818502810185019093528083529192909190830182828015612cf857602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311612cda575b50505050509050816060015115612d5e5780826080015181518110612d1f57612d1f614b1c565b6020026020010151818481518110612d3957612d39614b1c565b60200260200101906001600160a01b031690816001600160a01b031681525050612d9e565b612d6b8260400151613584565b818481518110612d7d57612d7d614b1c565b60200260200101906001600160a01b031690816001600160a01b0316815250505b6000848152600a602090815260409091208251612dbd92840190613f89565b5050505050565b612dcd82611e8d565b6001600160a01b0316336001600160a01b031614612e445760405162461bcd60e51b815260206004820152602e60248201527f4f6e6c792074686520746f6b656e206f776e65722063616e207365742074686560448201526d081c995b99195c881b595d1a1bd960921b60648201526084016103c2565b6000918252600c6020526040909120805460ff1916911515919091179055565b6000828152600d60209081526040808320848452825291829020805483518184028101840190945280845260609392830182828015612ec257602002820191906000526020600020905b815481526020019060010190808311612eae575b5050505050905092915050565b602754606090612f0990602290602390602490602590602690612ef19061371f565b604051612b4896959493929190602890602001615192565b604051602001612f19919061514d565b604051602081830303815290604052905090565b60408051808201909152606080825260208201526000838152600b60209081526040808320858452909152908190208151808301909252805482908290612f7390614ae8565b80601f0160208091040260200160405190810160405280929190818152602001828054612f9f90614ae8565b8015612fec5780601f10612fc157610100808354040283529160200191612fec565b820191906000526020600020905b815481529060010190602001808311612fcf57829003601f168201915b5050505050815260200160018201805461300590614ae8565b80601f016020809104026020016040519081016040528092919081815260200182805461303190614ae8565b801561307e5780601f106130535761010080835404028352916020019161307e565b820191906000526020600020905b81548152906001019060200180831161306157829003601f168201915b505050505081525050905092915050565b6009546001600160a01b031633146130b95760405162461bcd60e51b81526004016103c290614b32565b6001600160a01b03811661311e5760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b60648201526084016103c2565b61312781613951565b50565b60195460ff161561314d5760405162461bcd60e51b81526004016103c290614b67565b61315782826120de565b6131a35760405162461bcd60e51b815260206004820152601d60248201527f416c6c20746f6b656e73206d757374206265206475706c69636174657300000060448201526064016103c2565b60008183116131b257816131b4565b825b90506131c86009546001600160a01b031690565b6001600160a01b0316336001600160a01b031614613264576131e981611e8d565b6001600160a01b0316336001600160a01b0316146132645760405162461bcd60e51b815260206004820152603260248201527f4f6e6c792074686520746f6b656e206f776e6572206f7220636f6e7472616374604482015271081bdddb995c8818d85b881c994b5c9bdb1b60721b60648201526084016103c2565b61326d81613bf6565b61328061327b826001614a84565b6133aa565b1561329857613298613293826001614a84565b613bf6565b61168e816132a4613c26565b613c97565b6000546001600160a01b0383166132d257604051622e076360e81b815260040160405180910390fd5b816000036132f35760405163b562e8dd60e01b815260040160405180910390fd5b6001600160a01b0383166000908152600560205260408120805468010000000000000001850201905561334a90849061332d908281613448565b6001851460e11b174260a01b176001600160a01b03919091161790565b600082815260046020526040902055808281015b6040516001830192906001600160a01b038716906000907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef908290a480821061335e5760005550505050565b6000805482108015610d64575050600090815260046020526040902054600160e01b161590565b6060610d64826001600019613cec565b60008160005481101561342f5760008181526004602052604081205490600160e01b8216900361342d575b80600003610f2157506000190160008181526004602052604090205461340c565b505b604051636f96cda160e11b815260040160405180910390fd5b600060e882811c9061345b868684613da1565b62ffffff16901b95945050505050565b804710156134bb5760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a20696e73756666696369656e742062616c616e636500000060448201526064016103c2565b6000826001600160a01b03168260405160006040518083038185875af1925050503d8060008114613508576040519150601f19603f3d011682016040523d82523d6000602084013e61350d565b606091505b505090508061168e5760405162461bcd60e51b815260206004820152603a60248201527f416464726573733a20756e61626c6520746f2073656e642076616c75652c207260448201527f6563697069656e74206d6179206861766520726576657274656400000000000060648201526084016103c2565b6000806135af8360405160200161359b91906152bb565b604051602081830303815290604052613dc0565b90508051602082016000f091506001600160a01b0382166135e35760405163046a55db60e11b815260040160405180910390fd5b50919050565b60006135f482613dec565b6060015192915050565b600080805b600e846008811061361657613616614b1c565b01548110156103e3576000600e856008811061363457613634614b1c565b01828154811061364657613646614b1c565b9060005260206000200154905082861015801561366b57506136688184614a84565b86105b1561367a57509150610d649050565b6136848184614a84565b925050808061369290614acf565b915050613603565b601f1982015182518251603f199092019182906136b79083614a84565b11156137155760405162461bcd60e51b815260206004820152602760248201527f44796e616d69634275666665723a20417070656e64696e67206f7574206f66206044820152663137bab732399760c91b60648201526084016103c2565b6110228484613e63565b604080516080810191829052607f0190826030600a8206018353600a90045b801561375c57600183039250600a81066030018353600a900461373e565b50819003601f19909101908152919050565b606083600061377d8585614b93565b6001600160401b0381111561379457613794614187565b6040519080825280601f01601f1916602001820160405280156137be576020820181803683370190505b509050845b84811015613830578281815181106137dd576137dd614b1c565b01602001516001600160f81b031916826137f78884614b93565b8151811061380757613807614b1c565b60200101906001600160f81b031916908160001a9053508061382881614acf565b9150506137c3565b5095945050505050565b60008181805b82518160ff1610156138f0576030838260ff168151811061386357613863614b1c565b016020015160f81c1080159061389657506039838260ff168151811061388b5761388b614b1c565b016020015160f81c11155b156138de576138a6600a836152e1565b91506030838260ff16815181106138bf576138bf614b1c565b01602001516138d1919060f81c61530a565b6138db908361532d565b91505b806138e881615352565b915050613840565b509392505050565b60008160405160200161390b9190615371565b60405160208183030381529060405280519060200120836040516020016139329190615371565b6040516020818303038152906040528051906020012014905092915050565b600980546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b606081516000036139c257505060408051602081019091526000815290565b60006040518060600160405280604081526020016154ba60409139905060006003845160026139f19190614a84565b6139fb9190614059565b613a06906004614a9c565b6001600160401b03811115613a1d57613a1d614187565b6040519080825280601f01601f191660200182016040528015613a47576020820181803683370190505b509050600182016020820185865187015b80821015613ab3576003820191508151603f8160121c168501518453600184019350603f81600c1c168501518453600184019350603f8160061c168501518453600184019350603f8116850151845350600183019250613a58565b5050600386510660018114613acf5760028114613ae257613aea565b603d6001830353603d6002830353613aea565b603d60018303535b509195945050505050565b600082613b028584613e99565b14949350505050565b604051630a85bd0160e11b81526000906001600160a01b0385169063150b7a0290613b4090339089908890889060040161538d565b6020604051808303816000875af1925050508015613b7b575060408051601f3d908101601f19168201909252613b78918101906153ca565b60015b613bd9573d808015613ba9576040519150601f19603f3d011682016040523d82523d6000602084013e613bae565b606091505b508051600003613bd1576040516368d2bf6b60e11b815260040160405180910390fd5b805181602001fd5b6001600160e01b031916630a85bd0160e11b149050949350505050565b600081815260046020526040812054900361312757613c14816133e1565b60008281526004602052604090205550565b6000803a434244613c38600184614b93565b6040805160208101969096528501939093526060808501929092526080840152904060a083015233901b6bffffffffffffffffffffffff191660c082015260d40160408051601f19818403018152919052805160209091012092915050565b60008281526004602052604081205490819003613cc65760405162d5815360e01b815260040160405180910390fd5b6000928352600460205260409092206001600160e81b039290921660e89190911b179055565b6060833b6000819003613d0f575050604080516020810190915260008152610f21565b80841115613d2d575050604080516020810190915260008152610f21565b83831015613d5f5760405163162544fd60e11b81526004810182905260248101859052604481018490526064016103c2565b8383038482036000828210613d745782613d76565b815b60408051603f8301601f19168101909152818152955090508087602087018a3c505050509392505050565b60006001600160a01b03841615613db8578161257e565b61257e613c26565b6060815182604051602001613dd69291906153e7565b6040516020818303038152906040529050919050565b604080516080810182526000808252602082018190529181018290526060810191909152610d64613e1c836133e1565b604080516080810182526001600160a01b038316815260a083901c6001600160401b03166020820152600160e01b831615159181019190915260e89190911c606082015290565b8051602082019150808201602084510184015b81841015613e8e578351815260209384019301613e76565b505082510190915250565b600081815b84518110156138f0576000858281518110613ebb57613ebb614b1c565b60200260200101519050808311613ee15760008381526020829052604090209250613ef2565b600081815260208490526040902092505b5080613efd81614acf565b915050613e9e565b828054613f1190614ae8565b90600052602060002090601f016020900481019282613f335760008555613f79565b82601f10613f4c57805160ff1916838001178555613f79565b82800160010185558215613f79579182015b82811115613f79578251825591602001919060010190613f5e565b50613f85929150614018565b5090565b828054828255906000526020600020908101928215613f79579160200282015b82811115613f7957825182546001600160a01b0319166001600160a01b03909116178255602090920191600190910190613fa9565b828054828255906000526020600020908101928215613f795791602002820182811115613f79578251825591602001919060010190613f5e565b5b80821115613f855760008155600101614019565b634e487b7160e01b600052601260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b6000826140685761406861402d565b500490565b6001600160e01b03198116811461312757600080fd5b60006020828403121561409557600080fd5b8135610f218161406d565b60005b838110156140bb5781810151838201526020016140a3565b838111156110225750506000910152565b600081518084526140e48160208601602086016140a0565b601f01601f19169290920160200192915050565b602081526000610f2160208301846140cc565b60006020828403121561411d57600080fd5b5035919050565b80356001600160a01b0381168114610d1357600080fd5b6000806040838503121561414e57600080fd5b61415783614124565b946020939093013593505050565b6000806040838503121561417857600080fd5b50508035926020909101359150565b634e487b7160e01b600052604160045260246000fd5b60405160e081016001600160401b03811182821017156141bf576141bf614187565b60405290565b60405160a081016001600160401b03811182821017156141bf576141bf614187565b604080519081016001600160401b03811182821017156141bf576141bf614187565b604051601f8201601f191681016001600160401b038111828210171561423157614231614187565b604052919050565b600082601f83011261424a57600080fd5b81356001600160401b0381111561426357614263614187565b614276601f8201601f1916602001614209565b81815284602083860101111561428b57600080fd5b816020850160208301376000918101602001919091529392505050565b6000602082840312156142ba57600080fd5b81356001600160401b03808211156142d157600080fd5b9083019060e082860312156142e557600080fd5b6142ed61419d565b8235828111156142fc57600080fd5b61430887828601614239565b82525060208301358281111561431d57600080fd5b61432987828601614239565b60208301525060408301358281111561434157600080fd5b61434d87828601614239565b60408301525060608301358281111561436557600080fd5b61437187828601614239565b60608301525060808301358281111561438957600080fd5b61439587828601614239565b60808301525060a083013560a082015260c0830135828111156143b757600080fd5b6143c387828601614239565b60c08301525095945050505050565b6000806000606084860312156143e757600080fd5b6143f084614124565b92506143fe60208501614124565b9150604084013590509250925092565b60e08152600061442160e083018a6140cc565b8281036020840152614433818a6140cc565b9050828103604084015261444781896140cc565b9050828103606084015261445b81886140cc565b9050828103608084015261446f81876140cc565b90508460a084015282810360c084015261448981856140cc565b9a9950505050505050505050565b6000602082840312156144a957600080fd5b81356001600160401b038111156144bf57600080fd5b61257e84828501614239565b60006001600160401b038211156144e4576144e4614187565b5060051b60200190565b80358015158114610d1357600080fd5b600060a0828403121561451057600080fd5b6145186141c5565b905081356001600160401b038082111561453157600080fd5b61453d85838601614239565b8352602084013591508082111561455357600080fd5b61455f85838601614239565b6020840152604084013591508082111561457857600080fd5b5061458584828501614239565b604083015250614597606083016144ee565b60608201526080820135608082015292915050565b600080604083850312156145bf57600080fd5b823591506020808401356001600160401b03808211156145de57600080fd5b818601915086601f8301126145f257600080fd5b8135614605614600826144cb565b614209565b81815260059190911b8301840190848101908983111561462457600080fd5b8585015b8381101561465c578035858111156146405760008081fd5b61464e8c89838a01016144fe565b845250918601918601614628565b508096505050505050509250929050565b60006020828403121561467f57600080fd5b610f2182614124565b6000806040838503121561469b57600080fd5b6146a483614124565b91506146b2602084016144ee565b90509250929050565b60008083601f8401126146cd57600080fd5b5081356001600160401b038111156146e457600080fd5b6020830191508360208260051b85010111156146ff57600080fd5b9250929050565b60008060006040848603121561471b57600080fd5b61472484614124565b925060208401356001600160401b0381111561473f57600080fd5b61474b868287016146bb565b9497909650939450505050565b600082601f83011261476957600080fd5b81356020614779614600836144cb565b82815260059290921b8401810191818101908684111561479857600080fd5b8286015b848110156147b3578035835291830191830161479c565b509695505050505050565b600060208083850312156147d157600080fd5b82356001600160401b03808211156147e857600080fd5b818501915085601f8301126147fc57600080fd5b813561480a614600826144cb565b81815260059190911b8301840190848101908883111561482957600080fd5b8585015b838110156148bc578035858111156148455760008081fd5b86016040818c03601f190181131561485d5760008081fd5b6148656141e7565b89830135888111156148775760008081fd5b6148858e8c83870101614758565b82525090820135908782111561489b5760008081fd5b6148a98d8b84860101614758565b818b01528552505091860191860161482d565b5098975050505050505050565b600080600080608085870312156148df57600080fd5b6148e885614124565b93506148f660208601614124565b92506040850135915060608501356001600160401b0381111561491857600080fd5b61492487828801614239565b91505092959194509250565b60008060006040848603121561494557600080fd5b8335925060208401356001600160401b0381111561473f57600080fd5b60008060006060848603121561497757600080fd5b833592506020840135915060408401356001600160401b0381111561499b57600080fd5b6149a7868287016144fe565b9150509250925092565b600080604083850312156149c457600080fd5b823591506146b2602084016144ee565b6020808252825182820181905260009190848201906040850190845b81811015614a0c578351835292840192918401916001016149f0565b50909695505050505050565b60008060408385031215614a2b57600080fd5b614a3483614124565b91506146b260208401614124565b602081526000825160406020840152614a5e60608401826140cc565b90506020840151601f19848303016040850152614a7b82826140cc565b95945050505050565b60008219821115614a9757614a97614043565b500190565b6000816000190483118215151615614ab657614ab6614043565b500290565b600082614aca57614aca61402d565b500690565b600060018201614ae157614ae1614043565b5060010190565b600181811c90821680614afc57607f821691505b6020821081036135e357634e487b7160e01b600052602260045260246000fd5b634e487b7160e01b600052603260045260246000fd5b6020808252818101527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572604082015260600190565b60208082526012908201527110dbdb9d1c9858dd081a5cc81cd9585b195960721b604082015260600190565b600082821015614ba557614ba5614043565b500390565b8054600090600181811c9080831680614bc457607f831692505b60208084108203614be557634e487b7160e01b600052602260045260246000fd5b818015614bf95760018114614c0a57614c37565b60ff19861689528489019650614c37565b60008881526020902060005b86811015614c2f5781548b820152908501908301614c16565b505084890196505b50505050505092915050565b6e3d913a3930b4ba2fba3cb832911d1160891b81526000614c67600f830185614baa565b6a1116113b30b63ab2911d1160a91b8152614c85600b820185614baa565b61227d60f01b815260020195945050505050565b6000614ca58284614baa565b75076c4c2c6d6cee4deeadcc85ad2dac2ceca74eae4d8560531b81526016019392505050565b643230ba309d60d91b81526000614ce56005830185614baa565b670ed8985cd94d8d0b60c21b81528351614d068160088401602088016140a0565b6505258eae4d8560d31b60089290910191820152600e01949350505050565b643230ba309d60d91b81526000614d3f6005830185614baa565b670ed8985cd94d8d0b60c21b81528351614d608160088401602088016140a0565b7f293b6261636b67726f756e642d7265706561743a6e6f2d7265706561743b6261600892909101918201527f636b67726f756e642d73697a653a636f6e7461696e3b6261636b67726f756e6460288201527f2d706f736974696f6e3a63656e7465723b696d6167652d72656e646572696e6760488201527f3a2d7765626b69742d6f7074696d697a652d636f6e74726173743b2d6d732d6960688201527f6e746572706f6c6174696f6e2d6d6f64653a6e6561726573742d6e656967686260888201527f6f723b696d6167652d72656e646572696e673a2d6d6f7a2d63726973702d656460a88201527f6765733b696d6167652d72656e646572696e673a706978656c617465643b223e60c8820152651e17b9bb339f60d11b60e882015260ee01949350505050565b7f646174613a696d6167652f7376672b786d6c3b6261736536342c000000000000815260008251614ec181601a8501602087016140a0565b91909101601a0192915050565b60008351614ee08184602088016140a0565b701116113232b9b1b934b83a34b7b7111d1160791b908301908152614f086011820185614baa565b61088b60f21b815260020195945050505050565b681134b6b0b3b2911d1160b91b81526000614f3a6009830186614baa565b8451614f4a8183602089016140a0565b643f646e613d60d81b91019081528351614f6b8160058401602088016140a0565b71099b995d1ddbdc9acf5b585a5b9b995d088b60721b6005929091019182015260170195945050505050565b7f3c7376672077696474683d223130302522206865696768743d2231303025222081527f76696577426f783d2230203020313230302031323030222076657273696f6e3d60208201527f22312e322220786d6c6e733d22687474703a2f2f7777772e77332e6f72672f3260408201527f3030302f737667223e3c696d6167652077696474683d2231323030222068656960608201527033b43a1e91189918181110343932b31e9160791b60808201526000825161505b8160918501602087016140a0565b6f111f1e17b4b6b0b3b29f1e17b9bb339f60811b609193909101928301525060a101919050565b711139bb33afb4b6b0b3b2afb230ba30911d1160711b815281516000906150b08160128501602087016140a0565b61088b60f21b6012939091019283015250601401919050565b6d1134b6b0b3b2afb230ba30911d1160911b815281516000906150f381600e8501602087016140a0565b61088b60f21b600e939091019283015250601001919050565b6c1130ba3a3934b13aba32b9911d60991b8152815160009061513581600d8501602087016140a0565b607d60f81b600d939091019283015250600e01919050565b7f646174613a6170706c69636174696f6e2f6a736f6e3b6261736536342c00000081526000825161518581601d8501602087016140a0565b91909101601d0192915050565b683d913730b6b2911d1160b91b815260006151b0600983018a614baa565b701116113232b9b1b934b83a34b7b7111d1160791b81526151d4601182018a614baa565b6a11161134b6b0b3b2911d1160a91b815290506151f4600b820189614baa565b6b1116113130b73732b9111d1160a11b81529050615215600c820188614baa565b7211161132bc3a32b93730b62fb634b735911d1160691b8152905061523d6013820187614baa565b90507f222c2273656c6c65725f6665655f62617369735f706f696e7473223a000000008152845161527581601c8401602089016140a0565b7116113332b2afb932b1b4b834b2b73a111d1160711b601c92909101918201526152a2602e820185614baa565b61227d60f01b81526002019a9950505050505050505050565b60008152600082516152d48160018501602087016140a0565b9190910160010192915050565b600060ff821660ff84168160ff048111821515161561530257615302614043565b029392505050565b600060ff821660ff84168082101561532457615324614043565b90039392505050565b600060ff821660ff84168060ff0382111561534a5761534a614043565b019392505050565b600060ff821660ff810361536857615368614043565b60010192915050565b600082516153838184602087016140a0565b9190910192915050565b6001600160a01b03858116825284166020820152604081018390526080606082018190526000906153c0908301846140cc565b9695505050505050565b6000602082840312156153dc57600080fd5b8151610f218161406d565b606360f81b815260e083901b6001600160e01b03191660018201526880600e6000396000f360b81b6005820152815160009061542a81600e8501602087016140a0565b91909101600e01939250505056fe3c7376672077696474683d223132303022206865696768743d2231323030222076696577426f783d2230203020313230302031323030222076657273696f6e3d22312e322220786d6c6e733d22687474703a2f2f7777772e77332e6f72672f323030302f73766722207374796c653d226261636b67726f756e642d636f6c6f723a4142434445464748494a4b4c4d4e4f505152535455565758595a6162636465666768696a6b6c6d6e6f707172737475767778797a303132333435363738392b2fa26469706673582212202eb66edfd26a81682c47dd9ce86a7453ade967954892fbd280a13375596f36f164736f6c634300080e0033";
    let analyzer = common::new_analyzer_from_bytecode(bytecode, LazyWatchdog.in_rc())?;

    // Get the final storage layout for the input contract
    let layout = analyzer.analyze()?;

    // We should see 40 slots in our output, but we see 38
    assert_eq!(layout.slot_count(), 38);

    // `uint256`
    assert!(layout.has_slot(0, 0, AbiType::UInt { size: Some(256) }));

    // `uint256` but we infer `numberUnknown`
    assert!(layout.has_slot(1, 0, AbiType::Number { size: None }));

    // `string` but we infer `conflict`
    assert!(layout.has_slot(2, 0, AbiType::conflict()));

    // `string` but we infer `conflict`
    assert!(layout.has_slot(3, 0, AbiType::conflict()));

    // `mapping(uint256 => uint256)` but we infer `mapping(uint256 =>
    // struct(address, any, number1, number1, any, bytes3))`
    assert!(layout.has_slot(
        4,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::UInt { size: Some(256) }),
            value_type: Box::new(AbiType::Struct {
                elements: vec![
                    StructElement::new(0, AbiType::Address),
                    StructElement::new(160, AbiType::Any),
                    StructElement::new(224, AbiType::Number { size: Some(1) }),
                    StructElement::new(225, AbiType::Number { size: Some(1) }),
                    StructElement::new(226, AbiType::Any),
                    StructElement::new(232, AbiType::Bytes { length: Some(3) })
                ],
            }),
        }
    ));

    // `mapping(address => uint256)` but we infer `mapping(address => struct(bytes8,
    // uint64))`
    assert!(layout.has_slot(
        5,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::Address),
            value_type: Box::new(AbiType::Struct {
                elements: vec![
                    StructElement::new(0, AbiType::Bytes { length: Some(8) }),
                    StructElement::new(64, AbiType::UInt { size: Some(64) })
                ],
            }),
        }
    ));

    // `mapping(uint256 => address)` but we infer `mapping(uint256 => bytes20)`
    assert!(layout.has_slot(
        6,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::UInt { size: Some(256) }),
            value_type: Box::new(AbiType::Bytes { length: Some(20) }),
        }
    ));

    // `mapping(address => mapping(address => bool))` but we infer `mapping(address
    // => mapping(address => struct(number8, bytes31)))`
    assert!(layout.has_slot(
        7,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::Address),
            value_type: Box::new(AbiType::Mapping {
                key_type:   Box::new(AbiType::Address),
                value_type: Box::new(AbiType::Struct {
                    elements: vec![
                        StructElement::new(0, AbiType::Number { size: Some(8) }),
                        StructElement::new(8, AbiType::Bytes { length: Some(31) })
                    ],
                }),
            }),
        }
    ));

    // `uint256` but we infer `numberUnknown`
    assert!(layout.has_slot(8, 0, AbiType::Number { size: None }));

    // `address` but we infer `packed(address, bytes12)`
    assert!(layout.has_slot(9, 0, AbiType::Address));
    assert!(layout.has_slot(9, 160, AbiType::Bytes { length: Some(12) }));

    // `mapping(uint256 => address[])` but we infer `mapping(uint256 =>
    // struct(bytes20, bytes12)[])`
    assert!(layout.has_slot(
        10,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::UInt { size: Some(256) }),
            value_type: Box::new(AbiType::DynArray {
                tp: Box::new(AbiType::Struct {
                    elements: vec![
                        StructElement::new(0, AbiType::Bytes { length: Some(20) }),
                        StructElement::new(160, AbiType::Bytes { length: Some(12) }),
                    ],
                }),
            }),
        }
    ));

    // `mapping(uint256 => mapping(uint256 => struct(string, string)))` but we infer
    // `mapping(uint256 => mapping(bytes32 => struct(conflict, conflict)))`
    assert!(layout.has_slot(
        11,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::UInt { size: Some(256) }),
            value_type: Box::new(AbiType::Mapping {
                key_type:   Box::new(AbiType::Bytes { length: Some(32) }),
                value_type: Box::new(AbiType::Struct {
                    elements: vec![
                        StructElement::new(0, AbiType::conflict()),
                        StructElement::new(256, AbiType::conflict()),
                    ],
                }),
            }),
        }
    ));

    // `mapping(uint256 => bool)` but we infer `mapping(uint256 => struct(bytes1,
    // bytes31))`
    assert!(layout.has_slot(
        12,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::UInt { size: Some(256) }),
            value_type: Box::new(AbiType::Struct {
                elements: vec![
                    StructElement::new(0, AbiType::Bytes { length: Some(1) }),
                    StructElement::new(8, AbiType::Bytes { length: Some(31) }),
                ],
            }),
        }
    ));

    // `mapping(uint256 => mapping(uint256 => uint256[]))` but we infer
    // `mapping(number256 => mapping(uint256 => uintUnknown[]))`
    assert!(layout.has_slot(
        13,
        0,
        AbiType::Mapping {
            key_type:   Box::new(AbiType::Number { size: Some(256) }),
            value_type: Box::new(AbiType::Mapping {
                key_type:   Box::new(AbiType::UInt { size: Some(256) }),
                value_type: Box::new(AbiType::DynArray {
                    tp: Box::new(AbiType::UInt { size: None }),
                }),
            }),
        }
    ));

    // `uint256[][8]` but we do not see any part of it due to lacking support for
    // static arrays
    assert!(layout.has_no_slot_at(14));
    assert!(layout.has_no_slot_at(15));
    assert!(layout.has_no_slot_at(16));
    assert!(layout.has_no_slot_at(17));
    assert!(layout.has_no_slot_at(18));
    assert!(layout.has_no_slot_at(19));
    assert!(layout.has_no_slot_at(20));
    assert!(layout.has_no_slot_at(21));

    // `string[]` but we do not see it
    assert!(layout.has_no_slot_at(22));

    // `bool` but we infer `packed(number8, bytes31)`
    assert!(layout.has_slot(23, 0, AbiType::Number { size: Some(8) }));
    assert!(layout.has_slot(23, 8, AbiType::Bytes { length: Some(31) }));

    // `string` but we infer `packed(number1, uint7)`
    assert!(layout.has_slot(24, 0, AbiType::Number { size: Some(1) }));
    assert!(layout.has_slot(24, 1, AbiType::UInt { size: Some(7) }));

    // `bool` but we infer `packed(number8, bytes31)`
    assert!(layout.has_slot(25, 0, AbiType::Number { size: Some(8) }));
    assert!(layout.has_slot(25, 8, AbiType::Bytes { length: Some(31) }));

    // `uint256`
    assert!(layout.has_slot(26, 0, AbiType::UInt { size: Some(256) }));

    // `uint256` but we infer `uintUnknown`
    assert!(layout.has_slot(27, 0, AbiType::UInt { size: None }));

    // `string` but we infer `conflict`
    assert!(layout.has_slot(28, 0, AbiType::conflict()));

    // `bool` but we infer `packed(number8, bytes31)`
    assert!(layout.has_slot(29, 0, AbiType::Number { size: Some(8) }));
    assert!(layout.has_slot(29, 8, AbiType::Bytes { length: Some(31) }));

    // `bytes32`
    assert!(layout.has_slot(30, 0, AbiType::Bytes { length: Some(32) }));

    // `uint256`
    assert!(layout.has_slot(31, 0, AbiType::UInt { size: Some(256) }));

    // `uint256`
    assert!(layout.has_slot(32, 0, AbiType::UInt { size: Some(256) }));

    // `bool` but we infer `packed(number8, bytes31)`
    assert!(layout.has_slot(33, 0, AbiType::Number { size: Some(8) }));
    assert!(layout.has_slot(33, 8, AbiType::Bytes { length: Some(31) }));

    // `string` but we infer `conflict`
    assert!(layout.has_slot(34, 0, AbiType::conflict()));

    // `string` but we infer `conflict`
    assert!(layout.has_slot(35, 0, AbiType::conflict()));

    // `string` but we infer `conflict`
    assert!(layout.has_slot(36, 0, AbiType::conflict()));

    // `string` but we infer `packed(number1, uint7)`
    assert!(layout.has_slot(37, 0, AbiType::Number { size: Some(1) }));
    assert!(layout.has_slot(37, 1, AbiType::UInt { size: Some(7) }));

    // `string` but we miss it entirely
    assert!(layout.has_no_slot_at(38));

    // `uint256` but we infer `uintUnknown`
    assert!(layout.has_slot(39, 0, AbiType::UInt { size: None }));

    // `string` but we miss it entirely
    assert!(layout.has_no_slot_at(40));

    // `bytes32` but we infer `any`
    assert!(layout.has_slot(
        U256::from_str(
            "8980041631919178290161226234105977776452779202751091583642356499240698725347"
        )?,
        0,
        AbiType::Any
    ));

    Ok(())
}
